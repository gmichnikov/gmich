{% extends 'base.html' %}

{% block title %}Mastermind{% endblock %}

{% block content %}

<style>
  .mastermind-wrapper {
    min-height: calc(100vh - 70px - 60px); /* viewport minus navbar and footer */
    background: linear-gradient(to bottom right, #1e293b, #0f172a);
    padding: 2rem;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Oxygen, Ubuntu, Cantarell, sans-serif;
    margin: -20px; /* counteract main-content padding */
  }

  .mastermind-container {
    max-width: 56rem;
    margin: 0 auto;
  }

  .mastermind-wrapper h1 {
    font-size: 2.25rem;
    font-weight: bold;
    color: white;
    text-align: center;
    margin-bottom: 0.5rem;
  }

  .mastermind-subtitle {
    color: #d1d5db;
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .mastermind-possibilities-counter {
    background-color: #2563eb;
    color: white;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
    text-align: center;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  }

  .mastermind-possibilities-counter .mastermind-label {
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.25rem;
  }

  .mastermind-possibilities-counter .mastermind-count {
    font-size: 3rem;
    font-weight: bold;
  }

  .mastermind-possibilities-counter .mastermind-total {
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }

  .mastermind-section {
    background-color: #374151;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
  }

  .mastermind-section-title {
    color: white;
    text-align: center;
    margin-bottom: 0.75rem;
    font-weight: 600;
  }

  .mastermind-secret-code {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
  }

  .mastermind-game-status {
    text-align: center;
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 1.5rem;
  }

  .mastermind-game-status.mastermind-won {
    color: #4ade80;
  }

  .mastermind-game-status.mastermind-lost {
    color: #f87171;
  }

  .mastermind-guess-builder {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .mastermind-color-circle {
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    border: 2px solid #374151;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    flex-shrink: 0;
  }

  .mastermind-color-circle.mastermind-small {
    width: 2.5rem;
    height: 2.5rem;
    flex-shrink: 0;
  }

  .mastermind-color-circle.mastermind-palette {
    width: 2.25rem;
    height: 2.25rem;
  }

  .mastermind-empty-slot {
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    border: 2px dashed #6b7280;
    background-color: #4b5563;
  }

  .mastermind-buttons {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .mastermind-btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 0.25rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .mastermind-btn:disabled {
    background-color: #4b5563 !important;
    cursor: not-allowed;
    opacity: 0.5;
  }

  .mastermind-btn-undo {
    background-color: #dc2626;
    color: white;
  }

  .mastermind-btn-undo:hover:not(:disabled) {
    background-color: #b91c1c;
  }

  .mastermind-btn-submit {
    background-color: #16a34a;
    color: white;
    padding: 0.5rem 1.5rem;
  }

  .mastermind-btn-submit:hover:not(:disabled) {
    background-color: #15803d;
  }

  .mastermind-btn-new-game {
    background-color: #9333ea;
    color: white;
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
  }

  .mastermind-btn-new-game:hover {
    background-color: #7e22ce;
  }

  .mastermind-color-palette {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    flex-wrap: nowrap;
    overflow-x: auto;
    padding: 0.25rem;
  }

  .mastermind-color-button {
    transform: scale(1);
    transition: transform 0.2s;
    cursor: pointer;
    padding: 0;
    background: none;
    border: none;
  }

  .mastermind-color-button:hover:not(:disabled) {
    transform: scale(1.1);
  }

  .mastermind-color-button:disabled {
    opacity: 0.5;
  }

  .mastermind-guesses-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .mastermind-guess-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background-color: #1f2937;
    padding: 0.75rem;
    border-radius: 0.25rem;
  }

  .mastermind-guess-number {
    color: #9ca3af;
    width: 2rem;
  }

  .mastermind-guess-colors {
    display: flex;
    gap: 0.5rem;
    flex: 1;
  }

  .mastermind-feedback {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  .mastermind-pegs {
    display: flex;
    gap: 0.25rem;
    flex-wrap: wrap;
    width: 4rem;
  }

  .mastermind-peg {
    width: 1rem;
    height: 1rem;
    border-radius: 50%;
    border: 2px solid #9ca3af;
  }

  .mastermind-peg.mastermind-peg-red {
    background-color: #ef4444;
    border-color: #dc2626;
  }

  .mastermind-peg.mastermind-peg-white {
    background-color: white;
    border-color: #6b7280;
  }

  .mastermind-feedback-text {
    color: #d1d5db;
    font-size: 1rem;
    font-weight: 600;
    min-width: 4rem;
    text-align: center;
  }

  .mastermind-empty-state {
    color: #9ca3af;
    text-align: center;
    font-size: 0.875rem;
  }

  .mastermind-instructions {
    margin-top: 2rem;
  }

  .mastermind-instructions ul {
    list-style: none;
    color: #d1d5db;
    font-size: 0.875rem;
  }

  .mastermind-instructions li {
    margin-bottom: 0.25rem;
  }

  .mastermind-center {
    text-align: center;
    margin-top: 1.5rem;
  }

  .mastermind-small-label {
    color: white;
    text-align: center;
    margin-bottom: 0.75rem;
    font-size: 0.875rem;
  }
</style>

<div class="mastermind-wrapper">
  <div class="mastermind-container">
    <h1>Mastermind</h1>
    <p class="mastermind-subtitle">Crack the 4-color code!</p>

    <!-- Remaining Possibilities Counter -->
    <div class="mastermind-possibilities-counter">
      <div class="mastermind-label">Remaining Possibilities</div>
      <div class="mastermind-count" id="possibilitiesCount">1296</div>
      <div class="mastermind-total">out of 1,296 codes</div>
    </div>

    <!-- Secret Code (shown when game is over) -->
    <div id="secretCodeSection" class="mastermind-section" style="display: none">
      <div class="mastermind-section-title">Secret Code:</div>
      <div class="mastermind-secret-code" id="secretCode"></div>
    </div>

    <!-- Game Status -->
    <div id="gameStatus" class="mastermind-game-status" style="display: none"></div>

    <!-- Current Guess Builder -->
    <div id="guessBuilderSection" class="mastermind-section">
      <div class="mastermind-section-title" id="guessTitle">Your Guess (1/10)</div>
      <div class="mastermind-guess-builder" id="guessBuilder"></div>
      <div class="mastermind-buttons">
        <button class="mastermind-btn mastermind-btn-undo" id="undoBtn" onclick="removeLastColor()">
          Undo
        </button>
        <button class="mastermind-btn mastermind-btn-submit" id="submitBtn" onclick="submitGuess()">
          Submit Guess
        </button>
      </div>
    </div>

    <!-- Color Palette -->
    <div id="colorPaletteSection" class="mastermind-section">
      <div class="mastermind-small-label">Select Colors:</div>
      <div class="mastermind-color-palette" id="colorPalette"></div>
    </div>

    <!-- Previous Guesses -->
    <div class="mastermind-section">
      <div class="mastermind-section-title">Previous Guesses</div>
      <div id="guessesList" class="mastermind-guesses-list">
        <div class="mastermind-empty-state">No guesses yet</div>
      </div>
    </div>

    <!-- New Game Button -->
    <div class="mastermind-center">
      <button class="mastermind-btn mastermind-btn-new-game" onclick="startNewGame()">
        New Game
      </button>
    </div>

    <!-- Instructions -->
    <div class="mastermind-instructions">
      <ul>
        <li>ðŸŽ¯ Guess the secret 4-color code</li>
        <li>ðŸ”´ Red peg = Correct color in correct position</li>
        <li>âšª White peg = Correct color in wrong position</li>
        <li>ðŸ“Š Watch the remaining possibilities shrink with each guess!</li>
      </ul>
    </div>
  </div>
</div>

<script>
  // Game Constants
  const COLORS = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", "#ec4899"];
  const CODE_LENGTH = 4;
  const MAX_GUESSES = 10;

  // Game State
  let secret = [];
  let currentGuess = [];
  let guesses = [];
  let gameOver = false;
  let possibleCodes = [];

  // Generate all possible codes
  function generateAllCodes() {
    const codes = [];
    for (let i = 0; i < COLORS.length; i++) {
      for (let j = 0; j < COLORS.length; j++) {
        for (let k = 0; k < COLORS.length; k++) {
          for (let l = 0; l < COLORS.length; l++) {
            codes.push([COLORS[i], COLORS[j], COLORS[k], COLORS[l]]);
          }
        }
      }
    }
    return codes;
  }

  // Get feedback for a guess
  function getFeedback(secret, guess) {
    const secretCopy = [...secret];
    const guessCopy = [...guess];
    let black = 0;
    let white = 0;

    // Count black pegs (exact matches)
    for (let i = 0; i < CODE_LENGTH; i++) {
      if (guessCopy[i] === secretCopy[i]) {
        black++;
        secretCopy[i] = null;
        guessCopy[i] = null;
      }
    }

    // Count white pegs (color matches in wrong position)
    for (let i = 0; i < CODE_LENGTH; i++) {
      if (guessCopy[i] !== null) {
        const index = secretCopy.indexOf(guessCopy[i]);
        if (index !== -1) {
          white++;
          secretCopy[index] = null;
        }
      }
    }

    return { black, white };
  }

  // Check if two feedback objects are equal
  function feedbackEquals(f1, f2) {
    return f1.black === f2.black && f1.white === f2.white;
  }

  // Update possible codes based on guesses
  function updatePossibleCodes() {
    if (guesses.length === 0) {
      possibleCodes = generateAllCodes();
    } else {
      let remaining = generateAllCodes();

      for (const entry of guesses) {
        remaining = remaining.filter((code) => {
          const testFeedback = getFeedback(code, entry.guess);
          return feedbackEquals(testFeedback, entry.feedback);
        });
      }

      possibleCodes = remaining;
    }

    document.getElementById("possibilitiesCount").textContent =
      possibleCodes.length;
  }

  // Create a color circle element
  function createColorCircle(color, size = "") {
    const circle = document.createElement("div");
    circle.className = `mastermind-color-circle ${size ? 'mastermind-' + size : ''}`;
    circle.style.backgroundColor = color;
    return circle;
  }

  // Render the guess builder
  function renderGuessBuilder() {
    const builder = document.getElementById("guessBuilder");
    builder.innerHTML = "";

    for (let i = 0; i < CODE_LENGTH; i++) {
      if (currentGuess[i]) {
        builder.appendChild(createColorCircle(currentGuess[i]));
      } else {
        const emptySlot = document.createElement("div");
        emptySlot.className = "mastermind-empty-slot";
        builder.appendChild(emptySlot);
      }
    }

    // Update buttons
    document.getElementById("undoBtn").disabled = currentGuess.length === 0;
    document.getElementById("submitBtn").disabled =
      currentGuess.length !== CODE_LENGTH;
  }

  // Render color palette
  function renderColorPalette() {
    const palette = document.getElementById("colorPalette");
    palette.innerHTML = "";

    COLORS.forEach((color) => {
      const button = document.createElement("button");
      button.className = "mastermind-color-button";
      button.disabled = currentGuess.length >= CODE_LENGTH || gameOver;
      button.onclick = () => addColorToGuess(color);
      const circle = createColorCircle(color);
      circle.classList.add("mastermind-palette");
      button.appendChild(circle);
      palette.appendChild(button);
    });
  }

  // Render guesses list
  function renderGuessesList() {
    const list = document.getElementById("guessesList");

    if (guesses.length === 0) {
      list.innerHTML = '<div class="mastermind-empty-state">No guesses yet</div>';
      return;
    }

    list.innerHTML = "";
    guesses.forEach((entry, i) => {
      const row = document.createElement("div");
      row.className = "mastermind-guess-row";

      // Guess number
      const number = document.createElement("div");
      number.className = "mastermind-guess-number";
      number.textContent = `#${i + 1}`;
      row.appendChild(number);

      // Colors
      const colors = document.createElement("div");
      colors.className = "mastermind-guess-colors";
      entry.guess.forEach((color) => {
        colors.appendChild(createColorCircle(color, "small"));
      });
      row.appendChild(colors);

      // Feedback
      const feedback = document.createElement("div");
      feedback.className = "mastermind-feedback";

      const pegs = document.createElement("div");
      pegs.className = "mastermind-pegs";

      for (let j = 0; j < entry.feedback.black; j++) {
        const peg = document.createElement("div");
        peg.className = "mastermind-peg mastermind-peg-red";
        pegs.appendChild(peg);
      }

      for (let j = 0; j < entry.feedback.white; j++) {
        const peg = document.createElement("div");
        peg.className = "mastermind-peg mastermind-peg-white";
        pegs.appendChild(peg);
      }

      feedback.appendChild(pegs);

      const text = document.createElement("div");
      text.className = "mastermind-feedback-text";
      text.textContent = `${entry.feedback.black}R ${entry.feedback.white}W`;
      feedback.appendChild(text);

      row.appendChild(feedback);
      list.appendChild(row);
    });
  }

  // Add color to current guess
  function addColorToGuess(color) {
    if (currentGuess.length < CODE_LENGTH && !gameOver) {
      currentGuess.push(color);
      renderGuessBuilder();
      renderColorPalette();
    }
  }

  // Remove last color from guess
  function removeLastColor() {
    if (currentGuess.length > 0 && !gameOver) {
      currentGuess.pop();
      renderGuessBuilder();
      renderColorPalette();
    }
  }

  // Submit current guess
  function submitGuess() {
    if (currentGuess.length !== CODE_LENGTH || gameOver) return;

    const feedback = getFeedback(secret, currentGuess);
    guesses.push({ guess: [...currentGuess], feedback });
    currentGuess = [];

    updatePossibleCodes();
    renderGuessBuilder();
    renderGuessesList();
    renderColorPalette();

    document.getElementById("guessTitle").textContent = `Your Guess (${
      guesses.length + 1
    }/${MAX_GUESSES})`;

    if (feedback.black === CODE_LENGTH) {
      endGame(true);
    } else if (guesses.length >= MAX_GUESSES) {
      endGame(false);
    }
  }

  // End the game
  function endGame(won) {
    gameOver = true;

    // Show secret code
    const secretSection = document.getElementById("secretCodeSection");
    secretSection.style.display = "block";
    const secretCodeDiv = document.getElementById("secretCode");
    secretCodeDiv.innerHTML = "";
    secret.forEach((color) => {
      secretCodeDiv.appendChild(createColorCircle(color));
    });

    // Show game status
    const statusDiv = document.getElementById("gameStatus");
    statusDiv.style.display = "block";
    statusDiv.className = `mastermind-game-status ${won ? "mastermind-won" : "mastermind-lost"}`;
    statusDiv.textContent = won ? "ðŸŽ‰ You Won!" : "ðŸ˜ž Game Over";

    // Hide guess builder and color palette
    document.getElementById("guessBuilderSection").style.display = "none";
    document.getElementById("colorPaletteSection").style.display = "none";
  }

  // Start a new game
  function startNewGame() {
    const allCodes = generateAllCodes();
    secret = allCodes[Math.floor(Math.random() * allCodes.length)];
    currentGuess = [];
    guesses = [];
    gameOver = false;
    possibleCodes = allCodes;

    // Reset UI
    document.getElementById("secretCodeSection").style.display = "none";
    document.getElementById("gameStatus").style.display = "none";
    document.getElementById("guessBuilderSection").style.display = "block";
    document.getElementById("colorPaletteSection").style.display = "block";
    document.getElementById("guessTitle").textContent = "Your Guess (1/10)";

    updatePossibleCodes();
    renderGuessBuilder();
    renderColorPalette();
    renderGuessesList();
  }

  // Initialize game on page load
  window.onload = function () {
    startNewGame();
  };
</script>

{% endblock %}
