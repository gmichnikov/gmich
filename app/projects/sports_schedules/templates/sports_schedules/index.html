{% extends "base.html" %}

{% block title %}Sports Schedules{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('sports_schedules.static', filename='css/sports_schedules.css') }}">
{% endblock %}

{% block content %}
<div class="ss-wrapper">
  <h1 class="ss-title">Sports Schedules</h1>

  <div class="ss-layout">
    <aside class="ss-sidebar">
      <button type="button" class="ss-run-btn" id="ss-run-btn" onclick="ssRunQuery()">Run</button>
      <!-- Fields: Dimension + Filter per field (Looker-style) -->
      <div class="ss-section" data-section="fields">
        <div class="ss-section-header" onclick="ssToggleSection('fields')">
          <span>Fields</span>
          <span class="ss-section-toggle">â–¼</span>
        </div>
        <div class="ss-section-content">
          <div class="ss-field-actions">
            <button type="button" class="ss-field-action-btn" onclick="ssResetFields()">Reset</button>
            <button type="button" class="ss-field-action-btn" onclick="ssClearFields()">Clear</button>
          </div>
          <ul class="ss-fields-list">
            <li class="ss-field-row ss-field-header">
              <span class="ss-field-label">Field</span>
              <span class="ss-field-check">Dim</span>
              <span class="ss-field-check">Filter</span>
            </li>
            {% for col in field_order %}
            <li class="ss-field-row" data-field="{{ col }}">
              <span class="ss-field-label">{{ dimension_labels.get(col, col) }}</span>
              {% if col not in filter_only_fields %}
              <label class="ss-field-check">
                <input type="checkbox" id="ss-dim-{{ col }}" value="{{ col }}" class="ss-dimension-cb" {% if col in default_dimensions %}checked{% endif %}>
              </label>
              {% else %}
              <span class="ss-field-check ss-field-check-placeholder"></span>
              {% endif %}
              <label class="ss-field-check">
                <input type="checkbox" id="ss-filter-cb-{{ col }}" value="{{ col }}" class="ss-filter-cb" {% if col in default_filters %}checked{% endif %}>
              </label>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <!-- Options (count, limit, sort) -->
      <div class="ss-section" data-section="options">
        <div class="ss-section-header" onclick="ssToggleSection('options')">
          <span>Options</span>
          <span class="ss-section-toggle">â–¼</span>
        </div>
        <div class="ss-section-content">
          <div class="ss-filter-group">
            <label class="ss-dimension-item">
              <input type="checkbox" id="ss-count" class="ss-option-count">
              <span>Include count</span>
            </label>
          </div>
          <div class="ss-filter-group">
            <label class="ss-filter-label" for="ss-limit">Row limit</label>
            <input type="number" id="ss-limit" class="ss-filter-text" value="500" min="1" max="5000">
          </div>
          <div class="ss-filter-group">
            <label class="ss-filter-label" for="ss-sort-column">Sort by</label>
            <select id="ss-sort-column" class="ss-filter-select">
              <option value="">(first dimension)</option>
            </select>
          </div>
          <div class="ss-filter-group">
            <label class="ss-filter-label" for="ss-sort-dir">Sort direction</label>
            <select id="ss-sort-dir" class="ss-filter-select">
              <option value="asc">Ascending</option>
              <option value="desc">Descending</option>
            </select>
          </div>
        </div>
      </div>

      <input type="hidden" id="ss-anchor-date">
    </aside>

    <main class="ss-main">
      <!-- Filter bar: one row per active filter field (Looker-style), collapsible -->
      <div id="ss-filter-bar" class="ss-filter-bar" style="display: none;">
        <div class="ss-filter-bar-header" onclick="ssToggleFilterBar()">
          <span id="ss-filter-bar-title">Filters</span>
          <span class="ss-filter-bar-toggle" id="ss-filter-bar-toggle">â–¼</span>
        </div>
        <div class="ss-filter-bar-content" id="ss-filter-bar-content">
        {% for col in field_order %}
        <div class="ss-filter-bar-row" id="ss-filter-row-{{ col }}" data-filter-field="{{ col }}" style="display: none;">
          <label class="ss-filter-bar-label">{{ dimension_labels.get(col, col) }}</label>
          {% if col in low_cardinality_options %}<span class="ss-filter-selected" id="ss-filter-selected-{{ col }}"></span>{% endif %}
          <div class="ss-filter-bar-control">
            {% if col in low_cardinality_options %}
            <select multiple id="ss-filter-{{ col }}" class="ss-filter-multiselect" data-filter="{{ col }}">
              {% for value, label in low_cardinality_options[col] %}
              <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
            {% elif col == 'either_team' %}
            <div class="ss-filter-either-team">
              <input type="text" id="ss-filter-either-team-1" class="ss-filter-text" placeholder="Team 1" data-filter="either_team">
              <span class="ss-date-sep">vs</span>
              <input type="text" id="ss-filter-either-team-2" class="ss-filter-text" placeholder="Team 2 (optional)" data-filter="either_team">
            </div>
            {% elif col == 'date' %}
            <div class="ss-filter-date-inner">
              <select id="ss-date-mode-select" class="ss-date-mode-select">
                <option value="">None</option>
                <option value="exact">Exact date</option>
                <option value="today">Today</option>
                <option value="on_or_after">On or after</option>
                <option value="this_weekend">This weekend</option>
                <option value="range">Date range</option>
                <option value="year">Year only</option>
                <option value="last_n">Last N days</option>
                <option value="next_week" {% if default_filters.get('date') == 'next_week' %}selected{% endif %}>Next 7 days</option>
                <option value="next_n">Next N days</option>
              </select>
              <div id="ss-date-exact-group" class="ss-date-input-inline" style="display: none;"><input type="date" id="ss-date-exact" class="ss-filter-text"></div>
              <div id="ss-date-on-or-after-group" class="ss-date-input-inline" style="display: none;"><input type="date" id="ss-date-on-or-after" class="ss-filter-text"></div>
              <div id="ss-date-range-group" class="ss-date-input-inline" style="display: none;"><input type="date" id="ss-date-start" class="ss-filter-text"> <span class="ss-date-sep">to</span> <input type="date" id="ss-date-end" class="ss-filter-text"></div>
              <div id="ss-date-year-group" class="ss-date-input-inline" style="display: none;"><input type="number" id="ss-date-year" class="ss-filter-text" placeholder="e.g. 2026" min="2000" max="2100"></div>
              <div id="ss-date-n-group" class="ss-date-input-inline" style="display: none;"><input type="number" id="ss-date-n" class="ss-filter-text" placeholder="Days" min="1" max="365"></div>
            </div>
            {% else %}
            <input type="text" id="ss-filter-{{ col }}" class="ss-filter-text" placeholder="Contains..." data-filter="{{ col }}">
            {% endif %}
          </div>
          <button type="button" class="ss-filter-remove" title="Remove filter" onclick="ssRemoveFilter('{{ col }}')" aria-label="Remove filter">Ã—</button>
        </div>
        {% endfor %}
        </div>
      </div>

      <div id="ss-results-container" class="ss-results">
        <div id="ss-results-empty" class="ss-results-empty">
          Select dimensions and click Run to view schedules
        </div>
        <div id="ss-results-loading" class="ss-results-loading" style="display: none;">
          Loading...
        </div>
        <div id="ss-results-error" class="ss-results-error" style="display: none;"></div>
        <div id="ss-results-content" style="display: none;">
          <div id="ss-results-summary" class="ss-results-summary"></div>
          <div class="ss-results-table-wrapper">
            <table class="ss-results-table" id="ss-results-table"></table>
          </div>
          <div id="ss-results-actions" class="ss-results-actions">
            <div class="ss-action-buttons">
              <button type="button" class="ss-action-btn" id="ss-sql-toggle" onclick="ssToggleSql()">Show SQL</button>
              <button type="button" class="ss-action-btn" id="ss-copy-btn" onclick="ssCopyToClipboard()" title="Copy to clipboard (works in Excel, Google Sheets)">
                <span class="ss-copy-icon" aria-hidden="true">ðŸ“‹</span> Copy
              </button>
              <button type="button" class="ss-action-btn" id="ss-download-csv-btn" onclick="ssDownloadCsv()" title="Download as CSV file">Download CSV</button>
              <button type="button" class="ss-action-btn" id="ss-copy-url-btn" onclick="ssCopyUrl()" title="Copy shareable URL">Copy URL</button>
            </div>
            <pre id="ss-sql-content" class="ss-sql-content" style="display: none;"></pre>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
window.ssDimensionLabels = {{ dimension_labels | tojson }};
window.ssDefaultDimensions = {{ default_dimensions | tojson }};
window.ssDefaultFilters = {{ default_filters | tojson }};

(function() {
  function ssToggleSection(name) {
    const section = document.querySelector('[data-section="' + name + '"]');
    if (section) section.classList.toggle('collapsed');
  }
  window.ssToggleSection = ssToggleSection;

  function ssResetFields() {
    var dims = window.ssDefaultDimensions || [];
    var filters = window.ssDefaultFilters || {};
    document.querySelectorAll('.ss-dimension-cb').forEach(function(cb) {
      cb.checked = dims.indexOf(cb.value) >= 0;
    });
    document.querySelectorAll('.ss-filter-cb').forEach(function(cb) {
      var col = cb.value;
      cb.checked = col in filters;
    });
    if (filters.date === 'next_week') {
      var sel = document.getElementById('ss-date-mode-select');
      if (sel) sel.value = 'next_week';
    }
    document.querySelectorAll('.ss-filter-multiselect').forEach(function(s) {
      Array.from(s.options).forEach(function(o) { o.selected = false; });
    });
    document.querySelectorAll('.ss-filter-text[data-filter]').forEach(function(inp) { inp.value = ''; });
    var e1 = document.getElementById('ss-filter-either-team-1');
    var e2 = document.getElementById('ss-filter-either-team-2');
    if (e1) e1.value = '';
    if (e2) e2.value = '';
    ssUpdateDateModeVisibility();
    ssUpdateFilterBarVisibility();
    ssUpdateSortColumnOptions();
  }
  window.ssResetFields = ssResetFields;

  function ssClearFields() {
    document.querySelectorAll('.ss-dimension-cb').forEach(function(cb) { cb.checked = false; });
    document.querySelectorAll('.ss-filter-cb').forEach(function(cb) { cb.checked = false; });
    document.querySelectorAll('.ss-filter-multiselect').forEach(function(s) {
      Array.from(s.options).forEach(function(o) { o.selected = false; });
    });
    document.querySelectorAll('.ss-filter-text[data-filter]').forEach(function(inp) { inp.value = ''; });
    var e1 = document.getElementById('ss-filter-either-team-1');
    var e2 = document.getElementById('ss-filter-either-team-2');
    if (e1) e1.value = '';
    if (e2) e2.value = '';
    var sel = document.getElementById('ss-date-mode-select');
    if (sel) sel.value = '';
    ssUpdateDateModeVisibility();
    ssUpdateFilterBarVisibility();
    ssUpdateSortColumnOptions();
  }
  window.ssClearFields = ssClearFields;

  function ssRemoveFilter(col) {
    var cb = document.getElementById('ss-filter-cb-' + col);
    if (cb) {
      cb.checked = false;
      ssUpdateFilterBarVisibility();
    }
  }
  window.ssRemoveFilter = ssRemoveFilter;

  function ssToggleFilterBar() {
    const content = document.getElementById('ss-filter-bar-content');
    const toggle = document.getElementById('ss-filter-bar-toggle');
    if (!content || !toggle) return;
    const isCollapsed = content.classList.contains('ss-filter-bar-collapsed');
    if (isCollapsed) {
      content.classList.remove('ss-filter-bar-collapsed');
      toggle.textContent = 'â–¼';
    } else {
      content.classList.add('ss-filter-bar-collapsed');
      toggle.textContent = 'â–¶';
    }
  }
  window.ssToggleFilterBar = ssToggleFilterBar;

  function ssUpdateFilterBarVisibility() {
    const bar = document.getElementById('ss-filter-bar');
    let anyActive = false;
    document.querySelectorAll('.ss-filter-cb').forEach(function(cb) {
      const field = cb.value;
      const row = document.getElementById('ss-filter-row-' + field);
      if (row) {
        if (cb.checked) {
          row.style.display = 'flex';
          anyActive = true;
        } else {
          row.style.display = 'none';
        }
      }
    });
    bar.style.display = anyActive ? 'block' : 'none';
    var title = document.getElementById('ss-filter-bar-title');
    var count = document.querySelectorAll('.ss-filter-cb:checked').length;
    if (title) title.textContent = count > 0 ? 'Filters (' + count + ')' : 'Filters';
    ssUpdateAllFilterSelected();
  }

  function ssUpdateDateModeVisibility() {
    const sel = document.getElementById('ss-date-mode-select');
    const val = sel ? sel.value : '';
    var showVal = 'inline-flex';
    var g = document.getElementById('ss-date-exact-group'); if (g) g.style.display = val === 'exact' ? showVal : 'none';
    g = document.getElementById('ss-date-on-or-after-group');
    if (g) {
      g.style.display = val === 'on_or_after' ? showVal : 'none';
      if (val === 'on_or_after') {
        var inp = document.getElementById('ss-date-on-or-after');
        if (inp && !inp.value) inp.value = ssGetAnchorDate();
      }
    }
    g = document.getElementById('ss-date-range-group'); if (g) g.style.display = val === 'range' ? showVal : 'none';
    g = document.getElementById('ss-date-year-group'); if (g) g.style.display = val === 'year' ? showVal : 'none';
    g = document.getElementById('ss-date-n-group'); if (g) g.style.display = (val === 'last_n' || val === 'next_n') ? showVal : 'none';
  }

  function ssComputeThisWeekend(anchorYMD) {
    var d = new Date(anchorYMD + 'T12:00:00');
    var day = d.getDay();
    var friday, sunday;
    if (day >= 5 || day === 0) {
      friday = new Date(d);
      friday.setDate(d.getDate() - (day === 0 ? 2 : day - 5));
      sunday = new Date(friday);
      sunday.setDate(friday.getDate() + 2);
    } else {
      friday = new Date(d);
      friday.setDate(d.getDate() + (5 - day));
      sunday = new Date(friday);
      sunday.setDate(friday.getDate() + 2);
    }
    var fmt = function(x) {
      return x.getFullYear() + '-' + String(x.getMonth() + 1).padStart(2, '0') + '-' + String(x.getDate()).padStart(2, '0');
    };
    return { start: fmt(friday), end: fmt(sunday) };
  }

  document.querySelectorAll('.ss-filter-cb').forEach(function(cb) {
    cb.addEventListener('change', ssUpdateFilterBarVisibility);
  });

  function ssUpdateFilterSelected(col) {
    var el = document.getElementById('ss-filter-selected-' + col);
    if (!el) return;
    var sel = document.getElementById('ss-filter-' + col);
    var txt = '';
    if (sel && sel.multiple) {
      txt = Array.from(sel.selectedOptions).map(function(o) { return o.textContent; }).join(', ');
    }
    el.textContent = txt ? txt : '';
  }

  function ssUpdateAllFilterSelected() {
    ['sport', 'league', 'level', 'day', 'home_state'].forEach(ssUpdateFilterSelected);
  }

  function ssGetAnchorDate() {
    var el = document.getElementById('ss-anchor-date');
    if (el && el.value) return el.value;
    return new Date().toLocaleDateString('en-CA');
  }

  var dateModeSelect = document.getElementById('ss-date-mode-select');
  if (dateModeSelect) dateModeSelect.addEventListener('change', function() { ssUpdateDateModeVisibility(); ssUpdateFilterSelected('date'); });
  ssUpdateDateModeVisibility();
  ssUpdateFilterBarVisibility();

  document.querySelectorAll('.ss-filter-multiselect').forEach(function(sel) {
    sel.addEventListener('change', function() { ssUpdateFilterSelected(sel.dataset.filter); });
  });

  ssUpdateAllFilterSelected();

  function ssUpdateSortColumnOptions() {
    const sel = document.getElementById('ss-sort-column');
    if (!sel) return;
    const dimCbs = document.querySelectorAll('.ss-dimension-cb:checked');
    const dimensions = Array.from(dimCbs).map(cb => cb.value);
    const countOn = document.getElementById('ss-count') && document.getElementById('ss-count').checked;
    const labels = window.ssDimensionLabels || {};
    sel.innerHTML = '<option value="">(first dimension)</option>';
    dimensions.forEach(col => {
      const opt = document.createElement('option');
      opt.value = col;
      opt.textContent = labels[col] || col;
      sel.appendChild(opt);
    });
    if (countOn) {
      const opt = document.createElement('option');
      opt.value = '# Games';
      opt.textContent = '# Games';
      sel.appendChild(opt);
    }
  }
  document.querySelectorAll('.ss-dimension-cb').forEach(function(cb) {
    cb.addEventListener('change', ssUpdateSortColumnOptions);
  });
  document.getElementById('ss-count').addEventListener('change', ssUpdateSortColumnOptions);
  ssUpdateSortColumnOptions();

  function ssApplyParamsFromUrl() {
    var params = new URLSearchParams(window.location.search);
    if (params.toString() === '') return false;

    // Dimensions -> Dimension checkboxes
    var dims = params.get('dimensions');
    if (dims) {
      var arr = dims.split(',');
      document.querySelectorAll('.ss-dimension-cb').forEach(function(cb) {
        cb.checked = arr.indexOf(cb.value) >= 0;
      });
    }

    // Filter fields: check Filter CB for any field that has filter values in URL
    var filterFields = ['sport', 'league', 'level', 'day', 'home_state', 'home_team', 'road_team', 'location', 'home_city', 'date', 'either_team'];
    filterFields.forEach(function(col) {
      var isFilter = false;
      if (col === 'date') {
        isFilter = !!params.get('date_mode');
      } else if (col === 'either_team') {
        isFilter = !!(params.get('either_team_1') || params.get('either_team_2'));
      } else {
        isFilter = !!params.get(col);
      }
      var cb = document.getElementById('ss-filter-cb-' + col);
      if (cb) cb.checked = isFilter;
    });
    ssUpdateFilterBarVisibility();

    // Count
    var countEl = document.getElementById('ss-count');
    if (countEl) countEl.checked = params.get('count') === '1';

    // Limit
    var limitEl = document.getElementById('ss-limit');
    if (limitEl && params.get('limit')) limitEl.value = params.get('limit');

    // Sort (after dimensions/count so options exist)
    ssUpdateSortColumnOptions();
    var sortCol = document.getElementById('ss-sort-column');
    var sortDir = document.getElementById('ss-sort-dir');
    if (sortCol && params.get('sort_column')) sortCol.value = params.get('sort_column');
    if (sortDir && params.get('sort_dir')) sortDir.value = params.get('sort_dir') || 'asc';

    // Low-cardinality filters (multiselect in filter bar)
    ['sport', 'league', 'level', 'day', 'home_state'].forEach(function(col) {
      var val = params.get(col);
      if (val) {
        var sel = document.getElementById('ss-filter-' + col);
        if (sel) {
          var vals = val.split(',');
          Array.from(sel.options).forEach(function(opt) {
            opt.selected = vals.indexOf(opt.value) >= 0;
          });
        }
      }
    });

    // High-cardinality filters
    ['home_team', 'road_team', 'location', 'home_city'].forEach(function(col) {
      var val = params.get(col);
      if (val) {
        var inp = document.getElementById('ss-filter-' + col);
        if (inp) inp.value = val;
      }
    });

    // either_team
    var et1 = params.get('either_team_1');
    var et2 = params.get('either_team_2');
    if (et1) { var el = document.getElementById('ss-filter-either-team-1'); if (el) el.value = et1; }
    if (et2) { var el = document.getElementById('ss-filter-either-team-2'); if (el) el.value = et2; }

    // Date
    var dateMode = params.get('date_mode');
    if (dateMode) {
      var sel = document.getElementById('ss-date-mode-select');
      if (sel) {
        sel.value = dateMode;
        ssUpdateDateModeVisibility();
      }
      if (dateMode === 'exact') {
        var v = params.get('date_exact');
        if (v) { var el = document.getElementById('ss-date-exact'); if (el) el.value = v; }
      } else if (dateMode === 'on_or_after') {
        var v = params.get('date_exact');
        if (v) { var el = document.getElementById('ss-date-on-or-after'); if (el) el.value = v; }
        else { var el = document.getElementById('ss-date-on-or-after'); if (el) el.value = ssGetAnchorDate(); }
      } else if (dateMode === 'range') {
        var s = params.get('date_start'); if (s) { var el = document.getElementById('ss-date-start'); if (el) el.value = s; }
        var e = params.get('date_end'); if (e) { var el = document.getElementById('ss-date-end'); if (el) el.value = e; }
      } else if (dateMode === 'year') {
        var y = params.get('date_year'); if (y) { var el = document.getElementById('ss-date-year'); if (el) el.value = y; }
      } else if (dateMode === 'last_n' || dateMode === 'next_n') {
        var n = params.get('date_n'); if (n) { var el = document.getElementById('ss-date-n'); if (el) el.value = n; }
      }
      var anchor = params.get('anchor_date');
      if (anchor) { var el = document.getElementById('ss-anchor-date'); if (el) el.value = anchor; }
    }
    if (!dateMode || ['exact', 'today', 'on_or_after', 'this_weekend', 'range', 'year'].indexOf(dateMode) >= 0) {
      var el = document.getElementById('ss-anchor-date');
      if (el) el.value = '';
    }

    ssUpdateAllFilterSelected();
    return true;
  }

  function ssUpdateUrlFromParams(params) {
    var qs = params.toString();
    var url = qs ? (window.location.pathname + '?' + qs) : window.location.pathname;
    if (url.length <= 2000) window.history.replaceState({}, '', url);
  }

  function ssCollectParams() {
    const params = new URLSearchParams();

    // Dimensions (Dimension checkboxes, in DOM order)
    const dimCbs = document.querySelectorAll('.ss-dimension-cb:checked');
    const dimensions = Array.from(dimCbs).map(cb => cb.value);
    if (dimensions.length) params.set('dimensions', dimensions.join(','));

    // Count
    const countEl = document.getElementById('ss-count');
    if (countEl && countEl.checked) params.set('count', '1');

    // Limit
    const limitEl = document.getElementById('ss-limit');
    if (limitEl) params.set('limit', limitEl.value || '500');

    // Sort
    const sortCol = document.getElementById('ss-sort-column');
    const sortDir = document.getElementById('ss-sort-dir');
    if (sortCol && sortCol.value) params.set('sort_column', sortCol.value);
    if (sortDir) params.set('sort_dir', sortDir.value || 'asc');

    // Filters: only for fields where Filter is checked and has values
    document.querySelectorAll('.ss-filter-cb:checked').forEach(function(cb) {
      const col = cb.value;
      if (col === 'date') {
        const sel = document.getElementById('ss-date-mode-select');
        const mode = sel ? sel.value : '';
        if (mode === 'exact') {
          const v = document.getElementById('ss-date-exact');
          if (v && v.value) params.set('date_mode', 'exact'), params.set('date_exact', v.value);
        } else if (mode === 'today') {
          params.set('date_mode', 'today');
          params.set('date_exact', ssGetAnchorDate());
          params.set('anchor_date', ssGetAnchorDate());
        } else if (mode === 'on_or_after') {
          const v = document.getElementById('ss-date-on-or-after');
          var d = v && v.value ? v.value : ssGetAnchorDate();
          params.set('date_mode', 'on_or_after');
          params.set('date_exact', d);
        } else if (mode === 'this_weekend') {
          var w = ssComputeThisWeekend(ssGetAnchorDate());
          params.set('date_mode', 'this_weekend');
          params.set('date_start', w.start);
          params.set('date_end', w.end);
        } else if (mode === 'range') {
          const start = document.getElementById('ss-date-start');
          const end = document.getElementById('ss-date-end');
          if (start && start.value && end && end.value) {
            params.set('date_mode', 'range');
            params.set('date_start', start.value);
            params.set('date_end', end.value);
          }
        } else if (mode === 'year') {
          const y = document.getElementById('ss-date-year');
          if (y && y.value) params.set('date_mode', 'year'), params.set('date_year', y.value);
        } else if (mode === 'next_week') {
          params.set('date_mode', mode);
          params.set('anchor_date', ssGetAnchorDate());
        } else if (mode === 'last_n' || mode === 'next_n') {
          const nEl = document.getElementById('ss-date-n');
          const n = nEl ? parseInt(nEl.value, 10) : 0;
          if (n > 0) {
            params.set('date_mode', mode);
            params.set('date_n', String(n));
            params.set('anchor_date', ssGetAnchorDate());
          }
        }
      } else if (col === 'either_team') {
        const e1 = document.getElementById('ss-filter-either-team-1');
        const e2 = document.getElementById('ss-filter-either-team-2');
        const v1 = e1 ? e1.value.trim() : '';
        const v2 = e2 ? e2.value.trim() : '';
        if (v1) params.set('either_team_1', v1);
        if (v2) params.set('either_team_2', v2);
      } else {
        const sel = document.getElementById('ss-filter-' + col);
        if (sel && sel.multiple) {
          const vals = Array.from(sel.selectedOptions).map(o => o.value);
          if (vals.length) params.set(col, vals.join(','));
        } else {
          const inp = document.getElementById('ss-filter-' + col);
          if (inp && inp.value) params.set(col, inp.value.trim());
        }
      }
    });

    return params;
  }

  function ssRunQuery() {
    const dimensions = document.querySelectorAll('.ss-dimension-cb:checked');
    const countEl = document.getElementById('ss-count');
    const countOn = countEl && countEl.checked;

    if (dimensions.length === 0 && !countOn) {
      const errEl = document.getElementById('ss-results-error');
      errEl.textContent = 'Select at least one dimension or turn on count to run a query.';
      errEl.style.display = 'block';
      document.getElementById('ss-results-empty').style.display = 'none';
      document.getElementById('ss-results-loading').style.display = 'none';
      document.getElementById('ss-results-content').style.display = 'none';
      return;
    }

    var dateModeSel = document.getElementById('ss-date-mode-select');
    var mode = dateModeSel ? dateModeSel.value : '';
    if (mode === 'last_n' || mode === 'next_n') {
      var nEl = document.getElementById('ss-date-n');
      var n = nEl ? parseInt(nEl.value, 10) : 0;
      if (!n || n < 1) {
        var errEl = document.getElementById('ss-results-error');
        errEl.textContent = 'Number of days must be greater than 0.';
        errEl.style.display = 'block';
        document.getElementById('ss-results-empty').style.display = 'none';
        document.getElementById('ss-results-loading').style.display = 'none';
        document.getElementById('ss-results-content').style.display = 'none';
        return;
      }
    }

    document.getElementById('ss-results-error').style.display = 'none';
    document.getElementById('ss-results-empty').style.display = 'none';
    document.getElementById('ss-results-content').style.display = 'none';
    document.getElementById('ss-results-loading').style.display = 'flex';

    const params = ssCollectParams();
    fetch('/sports-schedules/api/query?' + params.toString())
      .then(function(r) { return r.json(); })
      .then(function(data) {
        document.getElementById('ss-results-loading').style.display = 'none';
        if (data.error) {
          document.getElementById('ss-results-error').textContent = data.error;
          document.getElementById('ss-results-error').style.display = 'block';
          return;
        }
        ssRenderResults(data.rows || [], data.sql || '', params.get('dimensions') || '', params.get('limit') || '500');
        document.getElementById('ss-results-content').style.display = 'block';
        ssUpdateSqlSection(data.sql || '');
        ssUpdateUrlFromParams(params);
      })
      .catch(function() {
        document.getElementById('ss-results-loading').style.display = 'none';
        document.getElementById('ss-results-error').textContent = 'Unable to load data. Please try again.';
        document.getElementById('ss-results-error').style.display = 'block';
      });
  }
  window.ssRunQuery = ssRunQuery;

  window._ssSortState = { col: null, dir: 'asc' };

  function ssRenderTableBody(rows, headers, labels) {
    const table = document.getElementById('ss-results-table');
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    rows.forEach(function(row, idx) {
      const tr = document.createElement('tr');
      const tdNum = document.createElement('td');
      tdNum.textContent = idx + 1;
      tdNum.className = 'ss-row-num';
      tr.appendChild(tdNum);
      headers.forEach(h => {
        const td = document.createElement('td');
        td.textContent = row[h] != null ? row[h] : '';
        tr.appendChild(td);
      });
      const tdCal = document.createElement('td');
      tdCal.className = 'ss-cal-cell';
      if (row.date) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'ss-cal-add-btn';
        btn.title = 'Add to Google Calendar';
        btn.innerHTML = '&#128197;';
        btn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          var url = ssBuildGoogleCalUrl(row);
          if (url) window.open(url, '_blank');
        };
        tdCal.appendChild(btn);
      }
      tr.appendChild(tdCal);
      tbody.appendChild(tr);
    });
  }

  function ssUpdateSortIndicators() {
    var state = window._ssSortState;
    var allTh = document.querySelectorAll('.ss-results-table thead th[data-sort-col]');
    allTh.forEach(function(th) {
      var col = th.getAttribute('data-sort-col');
      var label = th.getAttribute('data-sort-label');
      var isActive = state.col === col;
      th.textContent = label + (isActive ? (state.dir === 'asc' ? ' \u2191' : ' \u2193') : '');
    });
  }

  function ssParseTimeToMinutes(str) {
    if (!str || str === '') return null;
    str = String(str).trim();
    var m = str.match(/^(\d{1,2}):(\d{2})(?:\s*(AM|PM))?$/i);
    if (!m) return null;
    var h = parseInt(m[1], 10);
    var min = parseInt(m[2], 10) || 0;
    if (m[3]) {
      if (/pm/i.test(m[3]) && h < 12) h += 12;
      if (/am/i.test(m[3]) && h === 12) h = 0;
    }
    return h * 60 + min;
  }

  function ssHandleSort(col) {
    var state = window._ssSortState;
    var data = window._ssLastSortData;
    if (!data || !data.rows.length) return;
    var newDir = state.col === col ? (state.dir === 'asc' ? 'desc' : 'asc') : 'asc';
    state.col = col;
    state.dir = newDir;
    var sorted = data.rows.slice();
    sorted.sort(function(a, b) {
      var va, vb;
      if (col === '__num__') {
        va = data.rows.indexOf(a);
        vb = data.rows.indexOf(b);
        return newDir === 'asc' ? va - vb : vb - va;
      }
      va = a[col];
      vb = b[col];
      if (va == null && vb == null) return 0;
      if (va == null) return 1;
      if (vb == null) return -1;
      var cmp;
      var ma = ssParseTimeToMinutes(va);
      var mb = ssParseTimeToMinutes(vb);
      if (ma != null && mb != null) {
        cmp = ma - mb;
      } else if (col === '# Games' || col === '#Games') {
        cmp = (Number(va) || 0) - (Number(vb) || 0);
      } else if (col === 'date' || (String(va).match(/^\d{4}-\d{2}-\d{2}$/) && String(vb).match(/^\d{4}-\d{2}-\d{2}$/))) {
        cmp = String(va).localeCompare(String(vb));
      } else {
        cmp = String(va).localeCompare(String(vb), undefined, { numeric: true });
      }
      return newDir === 'asc' ? cmp : -cmp;
    });
    ssRenderTableBody(sorted, data.headers, data.labels);
    ssUpdateSortIndicators();
    window._ssLastSortData = { rows: sorted, headers: data.headers, labels: data.labels };
    window._ssLastExportData = {
      headerLabels: data.headers.map(function(h) {
        return (data.labels[h] || h).includes('Games') ? '# Games' : (data.labels[h] || h.replace(/_/g, ' '));
      }),
      headers: data.headers,
      rows: sorted.map(function(row) {
        return data.headers.map(function(h) { return row[h] != null ? String(row[h]) : ''; });
      })
    };
  }

  function ssRenderResults(rows, sql, dimensionsStr, limit) {
    const table = document.getElementById('ss-results-table');
    const summaryEl = document.getElementById('ss-results-summary');

    var rowKeys = rows.length && rows[0] ? Object.keys(rows[0]) : [];
    var requestedDims = dimensionsStr ? dimensionsStr.split(',').map(function(s) { return s.trim(); }).filter(Boolean) : [];
    var headers;
    if (requestedDims.length > 0) {
      headers = requestedDims.filter(function(h) { return rowKeys.indexOf(h) >= 0; });
      rowKeys.forEach(function(k) {
        if (headers.indexOf(k) < 0) headers.push(k);
      });
    } else {
      headers = rowKeys;
    }

    summaryEl.textContent = rows.length === parseInt(limit) && limit >= 500
      ? rows.length + ' rows (limit reached)'
      : 'Showing ' + rows.length + ' rows';

    table.innerHTML = '';
    if (headers.length === 0) {
      window._ssLastExportData = { headerLabels: [], headers: [], rows: [] };
      return;
    }

    window._ssSortState = { col: null, dir: 'asc' };
    const labels = window.ssDimensionLabels || {};

    const thead = document.createElement('thead');
    const tr = document.createElement('tr');
    const thNum = document.createElement('th');
    thNum.textContent = '#';
    thNum.className = 'ss-row-num-header ss-sortable';
    thNum.setAttribute('data-sort-col', '__num__');
    thNum.setAttribute('data-sort-label', '#');
    thNum.addEventListener('click', function() { ssHandleSort('__num__'); });
    tr.appendChild(thNum);
    headers.forEach(h => {
      const th = document.createElement('th');
      const label = h.includes('Games') ? '# Games' : (labels[h] || h.replace(/_/g, ' '));
      th.textContent = label;
      th.className = 'ss-sortable';
      th.setAttribute('data-sort-col', h);
      th.setAttribute('data-sort-label', label);
      th.addEventListener('click', function() { ssHandleSort(h); });
      tr.appendChild(th);
    });
    const thCal = document.createElement('th');
    thCal.className = 'ss-cal-header';
    tr.appendChild(thCal);
    thead.appendChild(tr);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    table.appendChild(tbody);
    window._ssLastSortData = { rows: rows, headers: headers, labels: labels };
    ssRenderTableBody(rows, headers, labels);

    window._ssLastSql = sql;
    window._ssLastExportData = {
      headerLabels: headers.map(function(h) {
        return (labels[h] || h).includes('Games') ? '# Games' : (labels[h] || h.replace(/_/g, ' '));
      }),
      headers: headers,
      rows: rows.map(function(row) {
        return headers.map(function(h) { return row[h] != null ? String(row[h]) : ''; });
      })
    };
  }

  function ssBuildGoogleCalUrl(row) {
    var dateStr = row.date;
    if (!dateStr) return null;
    var d = dateStr.replace(/-/g, '');
    var title = 'Game';
    if (row.home_team && row.road_team) {
      title = row.road_team + ' @ ' + row.home_team;
    } else if (row.home_team) title = row.home_team;
    else if (row.road_team) title = row.road_team;
    var timeStr = (row.time || '').toString().trim();
    var startDt, endDt;
    if (timeStr && /\d{1,2}:\d{2}/.test(timeStr)) {
      var parts = timeStr.split(':');
      var h = parseInt(parts[0], 10);
      var m = parseInt((parts[1] || '0').replace(/\D/g, ''), 10) || 0;
      if (/pm/i.test(timeStr) && h < 12) h += 12;
      if (/am/i.test(timeStr) && h === 12) h = 0;
      var start = new Date(dateStr + 'T12:00:00');
      start.setHours(h, m, 0, 0);
      var end = new Date(start.getTime() + 2.5 * 60 * 60 * 1000);
      var fmt = function(d) {
        return d.getFullYear() + ('0' + (d.getMonth() + 1)).slice(-2) + ('0' + d.getDate()).slice(-2) + 'T' + ('0' + d.getHours()).slice(-2) + ('0' + d.getMinutes()).slice(-2) + '00';
      };
      startDt = fmt(start);
      endDt = fmt(end);
    } else {
      startDt = d;
      var nextD = new Date(dateStr);
      nextD.setDate(nextD.getDate() + 1);
      endDt = nextD.toISOString().slice(0, 10).replace(/-/g, '');
    }
    var params = [
      'action=TEMPLATE',
      'text=' + encodeURIComponent(title),
      'dates=' + startDt + '/' + endDt
    ];
    var locParts = [];
    if (row.location) locParts.push(row.location);
    if (row.home_city || row.home_state) {
      locParts.push([row.home_city, row.home_state].filter(Boolean).join(', '));
    }
    if (locParts.length) params.push('location=' + encodeURIComponent(locParts.join(', ')));
    var details = [];
    if (row.league) details.push(row.league);
    if (row.sport) details.push(row.sport);
    if (details.length) params.push('details=' + encodeURIComponent(details.join(' Â· ')));
    return 'https://calendar.google.com/calendar/render?' + params.join('&');
  }

  function ssEscapeCsvField(val) {
    if (val == null) return '';
    var s = String(val);
    if (/[,\r\n"]/.test(s)) {
      return '"' + s.replace(/"/g, '""') + '"';
    }
    return s;
  }

  function ssEscapeTsvField(val) {
    if (val == null) return '';
    var s = String(val);
    if (/[\t\r\n"]/.test(s)) {
      return '"' + s.replace(/"/g, '""') + '"';
    }
    return s;
  }

  function ssCopyToClipboard() {
    var data = window._ssLastExportData;
    if (!data || !data.rows.length) return;
    var lines = [data.headerLabels.map(ssEscapeTsvField).join('\t')];
    data.rows.forEach(function(row) {
      lines.push(row.map(ssEscapeTsvField).join('\t'));
    });
    var tsv = lines.join('\r\n');
    navigator.clipboard.writeText(tsv).then(function() {
      var btn = document.getElementById('ss-copy-btn');
      if (btn) {
        var orig = btn.innerHTML;
        btn.innerHTML = '<span class="ss-copy-icon" aria-hidden="true">âœ“</span> Copied!';
        btn.disabled = true;
        setTimeout(function() {
          btn.innerHTML = '<span class="ss-copy-icon" aria-hidden="true">ðŸ“‹</span> Copy';
          btn.disabled = false;
        }, 1500);
      }
    }).catch(function() {
      var btn = document.getElementById('ss-copy-btn');
      if (btn) btn.textContent = 'Copy failed';
    });
  }
  window.ssCopyToClipboard = ssCopyToClipboard;

  function ssDownloadCsv() {
    var data = window._ssLastExportData;
    if (!data || !data.rows.length) return;
    var lines = [data.headerLabels.map(ssEscapeCsvField).join(',')];
    data.rows.forEach(function(row) {
      lines.push(row.map(ssEscapeCsvField).join(','));
    });
    var csv = lines.join('\r\n');
    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'sports-schedules-' + new Date().toISOString().slice(0, 10) + '.csv';
    a.click();
    URL.revokeObjectURL(url);
  }
  window.ssDownloadCsv = ssDownloadCsv;

  function ssFormatAndHighlightSql(sql) {
    if (!sql) return '';
    var s = sql.trim();
    s = s.replace(/\s+/g, ' ');
    s = s.replace(/\s*,\s*/g, ', ');
    s = s.replace(/\s+FROM\s+/gi, '\nFROM ');
    s = s.replace(/\s+WHERE\s+/gi, '\nWHERE ');
    s = s.replace(/\s+GROUP BY\s+/gi, '\nGROUP BY ');
    s = s.replace(/\s+ORDER BY\s+/gi, '\nORDER BY ');
    s = s.replace(/\s+LIMIT\s+/gi, '\nLIMIT ');
    s = s.replace(/\s+AND\s+/gi, '\n  AND ');
    s = s.replace(/\s+OR\s+/gi, '\n  OR ');
    s = s.split('\n').map(function(line) { return '  ' + line.trim(); }).join('\n').trim();
    function escapeHtml(str) { return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
    s = escapeHtml(s);
    var kw = ['SELECT', 'FROM', 'WHERE', 'GROUP', 'ORDER', 'LIMIT', 'BY', 'AND', 'OR', 'IN', 'LIKE', 'BETWEEN', 'AS', 'LOWER', 'COUNT', 'NULL', 'VALUES'];
    kw.forEach(function(k) {
      var re = new RegExp('\\b(' + k + ')\\b', 'gi');
      s = s.replace(re, '<span class="ss-sql-kw">$1</span>');
    });
    s = s.replace(/'([^']*)'/g, '<span class="ss-sql-str">\'$1\'</span>');
    s = s.replace(/`([^`]*)`/g, '<span class="ss-sql-id">`$1`</span>');
    s = s.replace(/\b(\d+)\b/g, '<span class="ss-sql-num">$1</span>');
    return s;
  }

  function ssUpdateSqlSection(sql) {
    const toggle = document.getElementById('ss-sql-toggle');
    const content = document.getElementById('ss-sql-content');
    if (!toggle || !content) return;
    content.innerHTML = ssFormatAndHighlightSql(sql);
    content.style.display = 'none';
    toggle.textContent = 'Show SQL';
    toggle.classList.remove('ss-sql-expanded');
  }

  function ssToggleSql() {
    const content = document.getElementById('ss-sql-content');
    const toggle = document.getElementById('ss-sql-toggle');
    if (!content || !toggle) return;
    if (content.style.display === 'none') {
      content.style.display = 'block';
      toggle.textContent = 'Hide SQL';
      toggle.classList.add('ss-sql-expanded');
    } else {
      content.style.display = 'none';
      toggle.textContent = 'Show SQL';
      toggle.classList.remove('ss-sql-expanded');
    }
  }
  window.ssToggleSql = ssToggleSql;

  document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      ssRunQuery();
    }
  });

  function ssCopyUrl() {
    var params = ssCollectParams();
    var qs = params.toString();
    var url = qs ? (window.location.origin + window.location.pathname + '?' + qs) : (window.location.origin + window.location.pathname);
    navigator.clipboard.writeText(url).then(function() {
      var btn = document.getElementById('ss-copy-url-btn');
      if (btn) {
        var orig = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(function() { btn.textContent = orig; }, 1200);
      }
    }).catch(function() {
      var btn = document.getElementById('ss-copy-url-btn');
      if (btn) btn.textContent = 'Copy failed';
    });
  }
  window.ssCopyUrl = ssCopyUrl;

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ssInitFromUrl);
  } else {
    ssInitFromUrl();
  }

  function ssInitFromUrl() {
    if (ssApplyParamsFromUrl()) ssRunQuery();
  }
})();
</script>
{% endblock %}
