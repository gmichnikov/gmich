{% extends "base.html" %}

{% block title %}Sports Schedules{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('sports_schedules.static', filename='css/sports_schedules.css') }}">
{% endblock %}

{% block content %}
<div class="ss-wrapper">
  <h1 class="ss-title">Sports Schedules</h1>

  <div class="ss-layout">
    <aside class="ss-sidebar">
      <!-- Dimensions -->
      <div class="ss-section" data-section="dimensions">
        <div class="ss-section-header" onclick="ssToggleSection('dimensions')">
          <span>Dimensions</span>
          <span class="ss-section-toggle">â–¼</span>
        </div>
        <div class="ss-section-content">
          <ul class="ss-dimensions-list">
            {% for col, label in dimension_labels.items() %}
            <li class="ss-dimension-item">
              <input type="checkbox" id="ss-dim-{{ col }}" value="{{ col }}" class="ss-dimension-cb">
              <label for="ss-dim-{{ col }}">{{ label }}</label>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <!-- Filters -->
      <div class="ss-section" data-section="filters">
        <div class="ss-section-header" onclick="ssToggleSection('filters')">
          <span>Filters</span>
          <span class="ss-section-toggle">â–¼</span>
        </div>
        <div class="ss-section-content">
          <p class="ss-filter-hint">All filters combined with AND</p>

          {% for col, opts in low_cardinality_options.items() %}
          <div class="ss-filter-group">
            <label class="ss-filter-label" for="ss-filter-{{ col }}">{{ dimension_labels.get(col, col) }}</label>
            <select multiple id="ss-filter-{{ col }}" class="ss-filter-multiselect" data-filter="{{ col }}">
              {% for value, label in opts %}
              <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          {% endfor %}

          <div class="ss-filter-group">
            <label class="ss-filter-label" for="ss-filter-home_team">Home Team (contains)</label>
            <input type="text" id="ss-filter-home_team" class="ss-filter-text" placeholder="e.g., Celtics" data-filter="home_team">
          </div>
          <div class="ss-filter-group">
            <label class="ss-filter-label" for="ss-filter-road_team">Road Team (contains)</label>
            <input type="text" id="ss-filter-road_team" class="ss-filter-text" placeholder="e.g., Lakers" data-filter="road_team">
          </div>
          <div class="ss-filter-group">
            <label class="ss-filter-label" for="ss-filter-location">Location (contains)</label>
            <input type="text" id="ss-filter-location" class="ss-filter-text" placeholder="Venue name" data-filter="location">
          </div>
          <div class="ss-filter-group">
            <label class="ss-filter-label" for="ss-filter-home_city">City (contains)</label>
            <input type="text" id="ss-filter-home_city" class="ss-filter-text" placeholder="e.g., Boston" data-filter="home_city">
          </div>
        </div>
      </div>

      <!-- Date -->
      <div class="ss-section" data-section="date">
        <div class="ss-section-header" onclick="ssToggleSection('date')">
          <span>Date</span>
          <span class="ss-section-toggle">â–¼</span>
        </div>
        <div class="ss-section-content">
          <div class="ss-date-mode-group">
            <label class="ss-date-mode-label">Mode</label>
            <div class="ss-date-mode-options">
              <label class="ss-radio-label">
                <input type="radio" name="ss-date-mode" value="" checked class="ss-date-mode-radio">
                <span>None</span>
              </label>
              <label class="ss-radio-label">
                <input type="radio" name="ss-date-mode" value="exact" class="ss-date-mode-radio">
                <span>Exact date</span>
              </label>
              <label class="ss-radio-label">
                <input type="radio" name="ss-date-mode" value="range" class="ss-date-mode-radio">
                <span>Date range</span>
              </label>
              <label class="ss-radio-label">
                <input type="radio" name="ss-date-mode" value="year" class="ss-date-mode-radio">
                <span>Year only</span>
              </label>
              <label class="ss-radio-label">
                <input type="radio" name="ss-date-mode" value="last_week" class="ss-date-mode-radio">
                <span>Last week (7 days)</span>
              </label>
              <label class="ss-radio-label">
                <input type="radio" name="ss-date-mode" value="last_month" class="ss-date-mode-radio">
                <span>Last month (30 days)</span>
              </label>
              <label class="ss-radio-label">
                <input type="radio" name="ss-date-mode" value="last_n" class="ss-date-mode-radio">
                <span>Last N days</span>
              </label>
              <label class="ss-radio-label">
                <input type="radio" name="ss-date-mode" value="next_week" class="ss-date-mode-radio">
                <span>Next week (7 days)</span>
              </label>
              <label class="ss-radio-label">
                <input type="radio" name="ss-date-mode" value="next_n" class="ss-date-mode-radio">
                <span>Next N days</span>
              </label>
            </div>
          </div>
          <div id="ss-date-exact-group" class="ss-date-input-group" style="display: none;">
            <label class="ss-filter-label" for="ss-date-exact">Date</label>
            <input type="date" id="ss-date-exact" class="ss-filter-text">
          </div>
          <div id="ss-date-range-group" class="ss-date-input-group" style="display: none;">
            <label class="ss-filter-label" for="ss-date-start">Start date</label>
            <input type="date" id="ss-date-start" class="ss-filter-text">
            <label class="ss-filter-label" for="ss-date-end" style="margin-top: 0.5rem;">End date</label>
            <input type="date" id="ss-date-end" class="ss-filter-text">
          </div>
          <div id="ss-date-year-group" class="ss-date-input-group" style="display: none;">
            <label class="ss-filter-label" for="ss-date-year">Year</label>
            <input type="number" id="ss-date-year" class="ss-filter-text" placeholder="e.g., 2026" min="2000" max="2100">
          </div>
          <div id="ss-date-n-group" class="ss-date-input-group" style="display: none;">
            <label class="ss-filter-label" for="ss-date-n">Number of days</label>
            <input type="number" id="ss-date-n" class="ss-filter-text" placeholder="e.g., 14" min="1" max="365">
          </div>
        </div>
      </div>

      <!-- Options (count, limit, sort) -->
      <div class="ss-section" data-section="options">
        <div class="ss-section-header" onclick="ssToggleSection('options')">
          <span>Options</span>
          <span class="ss-section-toggle">â–¼</span>
        </div>
        <div class="ss-section-content">
          <div class="ss-filter-group">
            <label class="ss-dimension-item">
              <input type="checkbox" id="ss-count" class="ss-option-count">
              <span>Include count</span>
            </label>
          </div>
          <div class="ss-filter-group">
            <label class="ss-filter-label" for="ss-limit">Row limit</label>
            <input type="number" id="ss-limit" class="ss-filter-text" value="500" min="1" max="5000">
          </div>
          <div class="ss-filter-group">
            <label class="ss-filter-label" for="ss-sort-column">Sort by</label>
            <select id="ss-sort-column" class="ss-filter-select">
              <option value="">(first dimension)</option>
            </select>
          </div>
          <div class="ss-filter-group">
            <label class="ss-filter-label" for="ss-sort-dir">Sort direction</label>
            <select id="ss-sort-dir" class="ss-filter-select">
              <option value="asc">Ascending</option>
              <option value="desc">Descending</option>
            </select>
          </div>
        </div>
      </div>

      <input type="hidden" id="ss-anchor-date">
      <button type="button" class="ss-run-btn" id="ss-run-btn" onclick="ssRunQuery()">Run</button>
    </aside>

    <main class="ss-main">
      <div id="ss-results-container" class="ss-results">
        <div id="ss-results-empty" class="ss-results-empty">
          Select dimensions and click Run to view schedules
        </div>
        <div id="ss-results-loading" class="ss-results-loading" style="display: none;">
          Loading...
        </div>
        <div id="ss-results-error" class="ss-results-error" style="display: none;"></div>
        <div id="ss-results-content" style="display: none;">
          <div id="ss-results-summary" class="ss-results-summary"></div>
          <div class="ss-results-table-wrapper">
            <table class="ss-results-table" id="ss-results-table"></table>
          </div>
          <div id="ss-results-actions" class="ss-results-actions">
            <div class="ss-action-buttons">
              <button type="button" class="ss-action-btn" id="ss-sql-toggle" onclick="ssToggleSql()">Show SQL</button>
              <button type="button" class="ss-action-btn" id="ss-copy-btn" onclick="ssCopyToClipboard()" title="Copy to clipboard (works in Excel, Google Sheets)">
                <span class="ss-copy-icon" aria-hidden="true">ðŸ“‹</span> Copy
              </button>
              <button type="button" class="ss-action-btn" id="ss-download-csv-btn" onclick="ssDownloadCsv()" title="Download as CSV file">Download CSV</button>
            </div>
            <pre id="ss-sql-content" class="ss-sql-content" style="display: none;"></pre>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
window.ssDimensionLabels = {{ dimension_labels | tojson }};

(function() {
  function ssToggleSection(name) {
    const section = document.querySelector('[data-section="' + name + '"]');
    if (section) section.classList.toggle('collapsed');
  }
  window.ssToggleSection = ssToggleSection;

  function ssUpdateDateModeVisibility() {
    const mode = document.querySelector('input[name="ss-date-mode"]:checked');
    const val = mode ? mode.value : '';
    document.getElementById('ss-date-exact-group').style.display = val === 'exact' ? 'block' : 'none';
    document.getElementById('ss-date-range-group').style.display = val === 'range' ? 'block' : 'none';
    document.getElementById('ss-date-year-group').style.display = val === 'year' ? 'block' : 'none';
    document.getElementById('ss-date-n-group').style.display = (val === 'last_n' || val === 'next_n') ? 'block' : 'none';
  }

  function ssGetAnchorDate() {
    var el = document.getElementById('ss-anchor-date');
    if (el && el.value) return el.value;
    return new Date().toLocaleDateString('en-CA');
  }

  document.querySelectorAll('input[name="ss-date-mode"]').forEach(function(r) {
    r.addEventListener('change', ssUpdateDateModeVisibility);
  });
  ssUpdateDateModeVisibility();

  function ssUpdateSortColumnOptions() {
    const sel = document.getElementById('ss-sort-column');
    if (!sel) return;
    const dimCbs = document.querySelectorAll('.ss-dimension-cb:checked');
    const dimensions = Array.from(dimCbs).map(cb => cb.value);
    const countOn = document.getElementById('ss-count') && document.getElementById('ss-count').checked;
    const labels = window.ssDimensionLabels || {};
    sel.innerHTML = '<option value="">(first dimension)</option>';
    dimensions.forEach(col => {
      const opt = document.createElement('option');
      opt.value = col;
      opt.textContent = labels[col] || col;
      sel.appendChild(opt);
    });
    if (countOn) {
      const opt = document.createElement('option');
      opt.value = '# Games';
      opt.textContent = '# Games';
      sel.appendChild(opt);
    }
  }
  document.querySelectorAll('.ss-dimension-cb').forEach(function(cb) {
    cb.addEventListener('change', ssUpdateSortColumnOptions);
  });
  document.getElementById('ss-count').addEventListener('change', ssUpdateSortColumnOptions);
  ssUpdateSortColumnOptions();

  function ssApplyParamsFromUrl() {
    var params = new URLSearchParams(window.location.search);
    if (params.toString() === '') return false;

    // Dimensions
    var dims = params.get('dimensions');
    if (dims) {
      var arr = dims.split(',');
      document.querySelectorAll('.ss-dimension-cb').forEach(function(cb) {
        cb.checked = arr.indexOf(cb.value) >= 0;
      });
    }

    // Count
    var countEl = document.getElementById('ss-count');
    if (countEl) countEl.checked = params.get('count') === '1';

    // Limit
    var limitEl = document.getElementById('ss-limit');
    if (limitEl && params.get('limit')) limitEl.value = params.get('limit');

    // Sort (after dimensions/count so options exist)
    ssUpdateSortColumnOptions();
    var sortCol = document.getElementById('ss-sort-column');
    var sortDir = document.getElementById('ss-sort-dir');
    if (sortCol && params.get('sort_column')) sortCol.value = params.get('sort_column');
    if (sortDir && params.get('sort_dir')) sortDir.value = params.get('sort_dir') || 'asc';

    // Low-cardinality filters (multiselect)
    ['sport', 'league', 'level', 'day', 'home_state'].forEach(function(col) {
      var val = params.get(col);
      if (val) {
        var sel = document.getElementById('ss-filter-' + col);
        if (sel) {
          var vals = val.split(',');
          Array.from(sel.options).forEach(function(opt) {
            opt.selected = vals.indexOf(opt.value) >= 0;
          });
        }
      }
    });

    // High-cardinality filters
    ['home_team', 'road_team', 'location', 'home_city'].forEach(function(col) {
      var val = params.get(col);
      if (val) {
        var inp = document.getElementById('ss-filter-' + col);
        if (inp) inp.value = val;
      }
    });

    // Date
    var dateMode = params.get('date_mode');
    if (dateMode) {
      var radio = document.querySelector('input[name="ss-date-mode"][value="' + dateMode + '"]');
      if (radio) {
        radio.checked = true;
        ssUpdateDateModeVisibility();
      }
      if (dateMode === 'exact') {
        var v = params.get('date_exact');
        if (v) { var el = document.getElementById('ss-date-exact'); if (el) el.value = v; }
      } else if (dateMode === 'range') {
        var s = params.get('date_start'); if (s) { var el = document.getElementById('ss-date-start'); if (el) el.value = s; }
        var e = params.get('date_end'); if (e) { var el = document.getElementById('ss-date-end'); if (el) el.value = e; }
      } else if (dateMode === 'year') {
        var y = params.get('date_year'); if (y) { var el = document.getElementById('ss-date-year'); if (el) el.value = y; }
      } else if (dateMode === 'last_n' || dateMode === 'next_n') {
        var n = params.get('date_n'); if (n) { var el = document.getElementById('ss-date-n'); if (el) el.value = n; }
      }
      var anchor = params.get('anchor_date');
      if (anchor) { var el = document.getElementById('ss-anchor-date'); if (el) el.value = anchor; }
    }
    if (!dateMode || ['exact', 'range', 'year'].indexOf(dateMode) >= 0) {
      var el = document.getElementById('ss-anchor-date');
      if (el) el.value = '';
    }

    return true;
  }

  function ssUpdateUrlFromParams(params) {
    var qs = params.toString();
    var url = qs ? (window.location.pathname + '?' + qs) : window.location.pathname;
    if (url.length <= 2000) window.history.replaceState({}, '', url);
  }

  function ssCollectParams() {
    const params = new URLSearchParams();

    // Dimensions (checked, in DOM order)
    const dimCbs = document.querySelectorAll('.ss-dimension-cb:checked');
    const dimensions = Array.from(dimCbs).map(cb => cb.value);
    if (dimensions.length) params.set('dimensions', dimensions.join(','));

    // Count
    const countEl = document.getElementById('ss-count');
    if (countEl && countEl.checked) params.set('count', '1');

    // Limit
    const limitEl = document.getElementById('ss-limit');
    if (limitEl) params.set('limit', limitEl.value || '500');

    // Sort
    const sortCol = document.getElementById('ss-sort-column');
    const sortDir = document.getElementById('ss-sort-dir');
    if (sortCol && sortCol.value) params.set('sort_column', sortCol.value);
    if (sortDir) params.set('sort_dir', sortDir.value || 'asc');

    // Low-cardinality filters (multiselect)
    document.querySelectorAll('.ss-filter-multiselect').forEach(sel => {
      const col = sel.dataset.filter;
      const vals = Array.from(sel.selectedOptions).map(o => o.value);
      if (vals.length) params.set(col, vals.join(','));
    });

    // High-cardinality filters (text)
    document.querySelectorAll('.ss-filter-text[data-filter]').forEach(inp => {
      const col = inp.dataset.filter;
      const val = inp.value.trim();
      if (val) params.set(col, val);
    });

    // Date
    const dateMode = document.querySelector('input[name="ss-date-mode"]:checked');
    const mode = dateMode ? dateMode.value : '';
    if (mode === 'exact') {
      const v = document.getElementById('ss-date-exact');
      if (v && v.value) params.set('date_mode', 'exact'), params.set('date_exact', v.value);
    } else if (mode === 'range') {
      const start = document.getElementById('ss-date-start');
      const end = document.getElementById('ss-date-end');
      if (start && start.value && end && end.value) {
        params.set('date_mode', 'range');
        params.set('date_start', start.value);
        params.set('date_end', end.value);
      }
    } else if (mode === 'year') {
      const y = document.getElementById('ss-date-year');
      if (y && y.value) params.set('date_mode', 'year'), params.set('date_year', y.value);
    } else if (['last_week', 'last_month', 'next_week'].indexOf(mode) >= 0) {
      params.set('date_mode', mode);
      params.set('anchor_date', ssGetAnchorDate());
    } else if (mode === 'last_n' || mode === 'next_n') {
      const nEl = document.getElementById('ss-date-n');
      const n = nEl ? parseInt(nEl.value, 10) : 0;
      if (n > 0) {
        params.set('date_mode', mode);
        params.set('date_n', String(n));
        params.set('anchor_date', ssGetAnchorDate());
      }
    }

    return params;
  }

  function ssRunQuery() {
    const dimensions = document.querySelectorAll('.ss-dimension-cb:checked');
    const countEl = document.getElementById('ss-count');
    const countOn = countEl && countEl.checked;

    if (dimensions.length === 0 && !countOn) {
      const errEl = document.getElementById('ss-results-error');
      errEl.textContent = 'Select at least one dimension or turn on count to run a query.';
      errEl.style.display = 'block';
      document.getElementById('ss-results-empty').style.display = 'none';
      document.getElementById('ss-results-loading').style.display = 'none';
      document.getElementById('ss-results-content').style.display = 'none';
      return;
    }

    var dateMode = document.querySelector('input[name="ss-date-mode"]:checked');
    var mode = dateMode ? dateMode.value : '';
    if (mode === 'last_n' || mode === 'next_n') {
      var nEl = document.getElementById('ss-date-n');
      var n = nEl ? parseInt(nEl.value, 10) : 0;
      if (!n || n < 1) {
        var errEl = document.getElementById('ss-results-error');
        errEl.textContent = 'Number of days must be greater than 0.';
        errEl.style.display = 'block';
        document.getElementById('ss-results-empty').style.display = 'none';
        document.getElementById('ss-results-loading').style.display = 'none';
        document.getElementById('ss-results-content').style.display = 'none';
        return;
      }
    }

    document.getElementById('ss-results-error').style.display = 'none';
    document.getElementById('ss-results-empty').style.display = 'none';
    document.getElementById('ss-results-content').style.display = 'none';
    document.getElementById('ss-results-loading').style.display = 'flex';

    const params = ssCollectParams();
    fetch('/sports-schedules/api/query?' + params.toString())
      .then(function(r) { return r.json(); })
      .then(function(data) {
        document.getElementById('ss-results-loading').style.display = 'none';
        if (data.error) {
          document.getElementById('ss-results-error').textContent = data.error;
          document.getElementById('ss-results-error').style.display = 'block';
          return;
        }
        ssRenderResults(data.rows || [], data.sql || '', params.get('dimensions') || '', params.get('limit') || '500');
        document.getElementById('ss-results-content').style.display = 'block';
        ssUpdateSqlSection(data.sql || '');
        ssUpdateUrlFromParams(params);
      })
      .catch(function() {
        document.getElementById('ss-results-loading').style.display = 'none';
        document.getElementById('ss-results-error').textContent = 'Unable to load data. Please try again.';
        document.getElementById('ss-results-error').style.display = 'block';
      });
  }
  window.ssRunQuery = ssRunQuery;

  function ssRenderResults(rows, sql, dimensionsStr, limit) {
    const table = document.getElementById('ss-results-table');
    const summaryEl = document.getElementById('ss-results-summary');

    const headers = rows.length && rows[0] ? Object.keys(rows[0]) : [];

    summaryEl.textContent = rows.length === parseInt(limit) && limit >= 500
      ? rows.length + ' rows (limit reached)'
      : 'Showing ' + rows.length + ' rows';

    table.innerHTML = '';
    if (headers.length === 0) {
      window._ssLastExportData = { headerLabels: [], headers: [], rows: [] };
      return;
    }

    const labels = window.ssDimensionLabels || {};
    const thead = document.createElement('thead');
    const tr = document.createElement('tr');
    const thNum = document.createElement('th');
    thNum.textContent = '#';
    thNum.className = 'ss-row-num-header';
    tr.appendChild(thNum);
    headers.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h.includes('Games') ? '# Games' : (labels[h] || h.replace(/_/g, ' '));
      tr.appendChild(th);
    });
    const thCal = document.createElement('th');
    thCal.className = 'ss-cal-header';
    tr.appendChild(thCal);
    thead.appendChild(tr);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    rows.forEach(function(row, idx) {
      const tr = document.createElement('tr');
      const tdNum = document.createElement('td');
      tdNum.textContent = idx + 1;
      tdNum.className = 'ss-row-num';
      tr.appendChild(tdNum);
      headers.forEach(h => {
        const td = document.createElement('td');
        td.textContent = row[h] != null ? row[h] : '';
        tr.appendChild(td);
      });
      const tdCal = document.createElement('td');
      tdCal.className = 'ss-cal-cell';
      if (row.date) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'ss-cal-add-btn';
        btn.title = 'Add to Google Calendar';
        btn.innerHTML = '&#128197;';
        btn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          var url = ssBuildGoogleCalUrl(row);
          if (url) window.open(url, '_blank');
        };
        tdCal.appendChild(btn);
      }
      tr.appendChild(tdCal);
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);

    window._ssLastSql = sql;
    window._ssLastExportData = {
      headerLabels: headers.map(function(h) {
        return (labels[h] || h).includes('Games') ? '# Games' : (labels[h] || h.replace(/_/g, ' '));
      }),
      headers: headers,
      rows: rows.map(function(row) {
        return headers.map(function(h) { return row[h] != null ? String(row[h]) : ''; });
      })
    };
  }

  function ssBuildGoogleCalUrl(row) {
    var dateStr = row.date;
    if (!dateStr) return null;
    var d = dateStr.replace(/-/g, '');
    var title = 'Game';
    if (row.home_team && row.road_team) {
      title = row.road_team + ' @ ' + row.home_team;
    } else if (row.home_team) title = row.home_team;
    else if (row.road_team) title = row.road_team;
    var timeStr = (row.time || '').toString().trim();
    var startDt, endDt;
    if (timeStr && /\d{1,2}:\d{2}/.test(timeStr)) {
      var parts = timeStr.split(':');
      var h = parseInt(parts[0], 10);
      var m = parseInt((parts[1] || '0').replace(/\D/g, ''), 10) || 0;
      if (/pm/i.test(timeStr) && h < 12) h += 12;
      if (/am/i.test(timeStr) && h === 12) h = 0;
      var start = new Date(dateStr + 'T12:00:00');
      start.setHours(h, m, 0, 0);
      var end = new Date(start.getTime() + 2.5 * 60 * 60 * 1000);
      var fmt = function(d) {
        return d.getFullYear() + ('0' + (d.getMonth() + 1)).slice(-2) + ('0' + d.getDate()).slice(-2) + 'T' + ('0' + d.getHours()).slice(-2) + ('0' + d.getMinutes()).slice(-2) + '00';
      };
      startDt = fmt(start);
      endDt = fmt(end);
    } else {
      startDt = d;
      var nextD = new Date(dateStr);
      nextD.setDate(nextD.getDate() + 1);
      endDt = nextD.toISOString().slice(0, 10).replace(/-/g, '');
    }
    var params = [
      'action=TEMPLATE',
      'text=' + encodeURIComponent(title),
      'dates=' + startDt + '/' + endDt
    ];
    var locParts = [];
    if (row.location) locParts.push(row.location);
    if (row.home_city || row.home_state) {
      locParts.push([row.home_city, row.home_state].filter(Boolean).join(', '));
    }
    if (locParts.length) params.push('location=' + encodeURIComponent(locParts.join(', ')));
    var details = [];
    if (row.league) details.push(row.league);
    if (row.sport) details.push(row.sport);
    if (details.length) params.push('details=' + encodeURIComponent(details.join(' Â· ')));
    return 'https://calendar.google.com/calendar/render?' + params.join('&');
  }

  function ssEscapeCsvField(val) {
    if (val == null) return '';
    var s = String(val);
    if (/[,\r\n"]/.test(s)) {
      return '"' + s.replace(/"/g, '""') + '"';
    }
    return s;
  }

  function ssEscapeTsvField(val) {
    if (val == null) return '';
    var s = String(val);
    if (/[\t\r\n"]/.test(s)) {
      return '"' + s.replace(/"/g, '""') + '"';
    }
    return s;
  }

  function ssCopyToClipboard() {
    var data = window._ssLastExportData;
    if (!data || !data.rows.length) return;
    var lines = [data.headerLabels.map(ssEscapeTsvField).join('\t')];
    data.rows.forEach(function(row) {
      lines.push(row.map(ssEscapeTsvField).join('\t'));
    });
    var tsv = lines.join('\r\n');
    navigator.clipboard.writeText(tsv).then(function() {
      var btn = document.getElementById('ss-copy-btn');
      if (btn) {
        var orig = btn.innerHTML;
        btn.innerHTML = '<span class="ss-copy-icon" aria-hidden="true">âœ“</span> Copied!';
        btn.disabled = true;
        setTimeout(function() {
          btn.innerHTML = '<span class="ss-copy-icon" aria-hidden="true">ðŸ“‹</span> Copy';
          btn.disabled = false;
        }, 1500);
      }
    }).catch(function() {
      var btn = document.getElementById('ss-copy-btn');
      if (btn) btn.textContent = 'Copy failed';
    });
  }
  window.ssCopyToClipboard = ssCopyToClipboard;

  function ssDownloadCsv() {
    var data = window._ssLastExportData;
    if (!data || !data.rows.length) return;
    var lines = [data.headerLabels.map(ssEscapeCsvField).join(',')];
    data.rows.forEach(function(row) {
      lines.push(row.map(ssEscapeCsvField).join(','));
    });
    var csv = lines.join('\r\n');
    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'sports-schedules-' + new Date().toISOString().slice(0, 10) + '.csv';
    a.click();
    URL.revokeObjectURL(url);
  }
  window.ssDownloadCsv = ssDownloadCsv;

  function ssUpdateSqlSection(sql) {
    const toggle = document.getElementById('ss-sql-toggle');
    const content = document.getElementById('ss-sql-content');
    if (!toggle || !content) return;
    content.textContent = sql;
    content.style.display = 'none';
    toggle.textContent = 'Show SQL';
    toggle.classList.remove('ss-sql-expanded');
  }

  function ssToggleSql() {
    const content = document.getElementById('ss-sql-content');
    const toggle = document.getElementById('ss-sql-toggle');
    if (!content || !toggle) return;
    if (content.style.display === 'none') {
      content.style.display = 'block';
      toggle.textContent = 'Hide SQL';
      toggle.classList.add('ss-sql-expanded');
    } else {
      content.style.display = 'none';
      toggle.textContent = 'Show SQL';
      toggle.classList.remove('ss-sql-expanded');
    }
  }
  window.ssToggleSql = ssToggleSql;

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ssInitFromUrl);
  } else {
    ssInitFromUrl();
  }

  function ssInitFromUrl() {
    if (ssApplyParamsFromUrl()) ssRunQuery();
  }
})();
</script>
{% endblock %}
