{% extends 'base.html' %}

{% block title %}Simon Says{% endblock %}

{% block content %}

<style>
    .simon-says-wrapper {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: calc(100vh - 70px - 60px); /* viewport minus navbar and footer */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        margin: -20px; /* counteract main-content padding */
    }

    .simon-says-container {
        text-align: center;
        max-width: 600px;
        width: 100%;
    }

    .simon-says-wrapper h1 {
        color: white;
        font-size: 3em;
        margin-bottom: 20px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .simon-says-info-panel {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .simon-says-score-display {
        font-size: 1.5em;
        color: #333;
        margin-bottom: 15px;
    }

    .simon-says-score-display span {
        font-weight: bold;
        color: #667eea;
    }

    .simon-says-controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
    }

    .simon-says-btn {
        padding: 12px 24px;
        font-size: 1em;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .simon-says-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0,0,0,0.15);
    }

    .simon-says-btn:active {
        transform: translateY(0);
    }

    .simon-says-start-btn {
        background: #667eea;
        color: white;
        font-size: 1.1em;
        padding: 15px 30px;
    }

    .simon-says-start-btn:hover {
        background: #5568d3;
    }

    .simon-says-start-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }

    .simon-says-sound-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f0f0f0;
        padding: 10px 20px;
        border-radius: 8px;
    }

    .simon-says-sound-toggle label {
        cursor: pointer;
        user-select: none;
        color: #333;
        font-weight: 500;
    }

    .simon-says-sound-toggle input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .simon-says-game-board {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        max-width: 400px;
        margin: 0 auto;
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }

    .simon-says-color-button {
        width: 100%;
        aspect-ratio: 1;
        border: 4px solid rgba(255,255,255,0.3);
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.15s ease;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .simon-says-color-button:hover:not(.simon-says-disabled) {
        transform: scale(1.05);
        filter: brightness(1.2);
    }

    .simon-says-color-button:active:not(.simon-says-disabled) {
        transform: scale(0.95);
    }

    .simon-says-color-button.simon-says-disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .simon-says-color-button.simon-says-active {
        filter: brightness(1.8);
        transform: scale(1.05);
        box-shadow: 0 0 30px currentColor;
    }

    .simon-says-red {
        background: #e74c3c;
    }

    .simon-says-green {
        background: #2ecc71;
    }

    .simon-says-blue {
        background: #3498db;
    }

    .simon-says-yellow {
        background: #f1c40f;
    }

    .simon-says-message {
        min-height: 30px;
        color: white;
        font-size: 1.2em;
        font-weight: 600;
        margin-top: 20px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    .simon-says-message.simon-says-error {
        color: #ff6b6b;
    }

    .simon-says-message.simon-says-success {
        color: #51cf66;
    }

    @media (max-width: 480px) {
        .simon-says-wrapper h1 {
            font-size: 2em;
        }

        .simon-says-game-board {
            max-width: 300px;
            gap: 10px;
        }
    }
</style>

<div class="simon-says-wrapper">
    <div class="simon-says-container">
        <h1>Simon Says</h1>
        
        <div class="simon-says-info-panel">
            <div class="simon-says-score-display">
                Level: <span id="level">0</span> | Score: <span id="score">0</span>
            </div>
            
            <div class="simon-says-controls">
                <button class="simon-says-btn simon-says-start-btn" id="startBtn">Start Game</button>
                
                <div class="simon-says-sound-toggle">
                    <input type="checkbox" id="soundToggle">
                    <label for="soundToggle">Sound Effects</label>
                </div>
            </div>
        </div>

        <div class="simon-says-game-board">
            <div class="simon-says-color-button simon-says-disabled simon-says-red" id="red" data-color="red"></div>
            <div class="simon-says-color-button simon-says-disabled simon-says-green" id="green" data-color="green"></div>
            <div class="simon-says-color-button simon-says-disabled simon-says-blue" id="blue" data-color="blue"></div>
            <div class="simon-says-color-button simon-says-disabled simon-says-yellow" id="yellow" data-color="yellow"></div>
        </div>

        <div class="simon-says-message" id="message">Press Start to Play!</div>
    </div>
</div>

<script>
    // Game state
    let sequence = [];
    let playerSequence = [];
    let level = 0;
    let isPlaying = false;
    let isPlayerTurn = false;

    // DOM elements
    const startBtn = document.getElementById('startBtn');
    const soundToggle = document.getElementById('soundToggle');
    const levelDisplay = document.getElementById('level');
    const scoreDisplay = document.getElementById('score');
    const messageDisplay = document.getElementById('message');
    const colorButtons = document.querySelectorAll('.simon-says-color-button');

    // Audio context for sound generation
    let audioContext = null;

    // Color to frequency mapping (musical notes)
    const frequencies = {
        red: 329.63,    // E4
        green: 261.63,  // C4
        blue: 392.00,   // G4
        yellow: 440.00  // A4
    };

    // Initialize audio context on first user interaction
    function initAudio() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
    }

    // Play a tone for a specific color
    function playTone(color, duration = 400) {
        if (!soundToggle.checked || !audioContext) return;

        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = frequencies[color];
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration / 1000);
    }

    // Light up a color button
    function lightUp(color, duration = 300) {
        const button = document.getElementById(color);
        button.classList.add('simon-says-active');
        playTone(color, duration);

        setTimeout(() => {
            button.classList.remove('simon-says-active');
        }, duration);
    }

    // Show a message to the player
    function showMessage(text, type = '') {
        messageDisplay.textContent = text;
        messageDisplay.className = `simon-says-message ${type ? 'simon-says-' + type : ''}`;
    }

    // Generate next sequence
    function nextRound() {
        level++;
        levelDisplay.textContent = level;
        scoreDisplay.textContent = level - 1;

        const colors = ['red', 'green', 'blue', 'yellow'];
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        sequence.push(randomColor);

        playerSequence = [];
        isPlayerTurn = false;
        disableButtons();

        showMessage('Watch the pattern...', '');
        
        setTimeout(() => {
            playSequence();
        }, 500);
    }

    // Play the current sequence
    async function playSequence() {
        for (let i = 0; i < sequence.length; i++) {
            await new Promise(resolve => {
                setTimeout(() => {
                    lightUp(sequence[i]);
                    resolve();
                }, i === 0 ? 0 : 400);
            });
            await new Promise(resolve => setTimeout(resolve, 400));
        }

        isPlayerTurn = true;
        enableButtons();
        showMessage('Your turn! Repeat the pattern', 'success');
    }

    // Handle player color selection
    function handleColorClick(event) {
        if (!isPlayerTurn || !isPlaying) return;

        const color = event.target.dataset.color;
        playerSequence.push(color);
        lightUp(color, 250);

        const currentIndex = playerSequence.length - 1;

        // Check if the player's move is correct
        if (playerSequence[currentIndex] !== sequence[currentIndex]) {
            gameOver();
            return;
        }

        // Check if player completed the sequence
        if (playerSequence.length === sequence.length) {
            isPlayerTurn = false;
            disableButtons();
            showMessage('Correct! Get ready for next level...', 'success');
            
            setTimeout(() => {
                nextRound();
            }, 800);
        }
    }

    // Enable color buttons
    function enableButtons() {
        colorButtons.forEach(button => {
            button.classList.remove('simon-says-disabled');
        });
    }

    // Disable color buttons
    function disableButtons() {
        colorButtons.forEach(button => {
            button.classList.add('simon-says-disabled');
        });
    }

    // Start new game
    function startGame() {
        initAudio();
        sequence = [];
        playerSequence = [];
        level = 0;
        isPlaying = true;
        isPlayerTurn = false;

        levelDisplay.textContent = '0';
        scoreDisplay.textContent = '0';
        startBtn.disabled = true;
        startBtn.textContent = 'Playing...';

        showMessage('Get ready...', '');
        
        setTimeout(() => {
            nextRound();
        }, 300);
    }

    // Game over
    function gameOver() {
        isPlaying = false;
        isPlayerTurn = false;
        disableButtons();

        const finalScore = level - 1;
        showMessage(`Game Over! Final Score: ${finalScore}`, 'error');

        startBtn.disabled = false;
        startBtn.textContent = 'Play Again';

        // Flash all buttons red briefly
        colorButtons.forEach(button => {
            button.style.filter = 'brightness(0.5)';
        });

        setTimeout(() => {
            colorButtons.forEach(button => {
                button.style.filter = '';
            });
        }, 500);
    }

    // Event listeners
    startBtn.addEventListener('click', startGame);

    colorButtons.forEach(button => {
        button.addEventListener('click', handleColorClick);
    });

    soundToggle.addEventListener('change', () => {
        if (soundToggle.checked) {
            initAudio();
        }
    });
</script>

{% endblock %}
