{% extends "base.html" %}

{% block title %}Sports Schedule Admin{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('sports_schedule_admin.static', filename='css/sports_admin.css') }}">
{% endblock %}

{% block content %}
<div class="ssa-wrapper">
    <div class="ssa-header">
        <h1 class="ssa-title">ðŸ“… Sports Schedule Admin</h1>
        <div id="connection-status">
            <span class="ssa-status-badge ssa-status-badge--checking">Checking DoltHub...</span>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="ssa-tabs" id="ssa-tabs" role="tablist">
        <li class="ssa-tab-item">
            <button type="button" class="ssa-tab-btn ssa-tab-btn--active" data-ssa-panel="overview" role="tab">Overview</button>
        </li>
        <li class="ssa-tab-item">
            <button type="button" class="ssa-tab-btn" data-ssa-panel="operations" role="tab">Operations</button>
        </li>
        <li class="ssa-tab-item">
            <button type="button" class="ssa-tab-btn" data-ssa-panel="logs" role="tab">Activity Logs</button>
        </li>
        <li class="ssa-tab-item">
            <button type="button" class="ssa-tab-btn" data-ssa-panel="preview" role="tab">Data Preview</button>
        </li>
    </ul>

    <!-- Overview Panel -->
    <div id="panel-overview" class="ssa-panel ssa-panel--active" role="tabpanel">
        <div class="ssa-card">
            <div class="ssa-card-header ssa-card-header--flex">
                <span>League Coverage</span>
                <div class="ssa-toggle-group" role="group" aria-label="Coverage scope">
                    <button type="button" class="ssa-toggle-btn ssa-toggle-btn--active" data-ssa-scope="current_season" aria-pressed="true">Current season</button>
                    <button type="button" class="ssa-toggle-btn" data-ssa-scope="all_time" aria-pressed="false">All time</button>
                </div>
            </div>
            <div class="ssa-card-body" style="padding: 0;">
                <div id="coverage-table-container">
                    <div class="ssa-spinner">
                        <div class="ssa-spinner-icon" aria-hidden="true"></div>
                        <span class="ssa-spinner-text">Fetching stats from DoltHub...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Operations Panel -->
    <div id="panel-operations" class="ssa-panel" role="tabpanel">
        <div id="ssa-op-message" class="ssa-op-message" role="status" aria-live="polite"></div>
        <div class="ssa-grid">
            <div class="ssa-grid-card">
                <h3 class="ssa-grid-card-title">Manual Sync</h3>
                <p class="ssa-grid-card-desc">Fetch schedule data from ESPN or MLB Stats API and upsert to DoltHub.</p>
                
                <form id="ssa-sync-form" class="ssa-form">
                    <div class="ssa-form-group">
                        <label for="ssa-sync-league" class="ssa-label">League</label>
                        <select id="ssa-sync-league" name="league" class="ssa-select" required>
                            {% for code, label in leagues %}
                            <option value="{{ code }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Sync Mode (only for college) -->
                    <div id="ssa-sync-mode-group" class="ssa-form-group" style="display: none;">
                        <label class="ssa-label">Sync Mode</label>
                        <div class="ssa-toggle-group ssa-toggle-group--small">
                            <button type="button" class="ssa-toggle-btn ssa-toggle-btn--active" data-ssa-mode="range">Date Range</button>
                            <button type="button" class="ssa-toggle-btn" data-ssa-mode="team">By Team</button>
                        </div>
                    </div>

                    <!-- Date Range Inputs -->
                    <div id="ssa-sync-range-inputs">
                        <div class="ssa-form-group">
                            <label for="ssa-sync-start" class="ssa-label">Start Date</label>
                            <input type="date" id="ssa-sync-start" name="start_date" class="ssa-input">
                        </div>
                        <div class="ssa-form-row">
                            <div class="ssa-form-group ssa-form-group--flex">
                                <label for="ssa-sync-end" class="ssa-label">End Date (optional)</label>
                                <input type="date" id="ssa-sync-end" name="end_date" class="ssa-input">
                            </div>
                            <span class="ssa-form-or">or</span>
                            <div class="ssa-form-group ssa-form-group--flex">
                                <label for="ssa-sync-days" class="ssa-label">Days</label>
                                <input type="number" id="ssa-sync-days" name="days" class="ssa-input" min="1" value="7" placeholder="From start">
                            </div>
                        </div>
                    </div>

                    <!-- Team Selection Input (hidden by default) -->
                    <div id="ssa-sync-team-inputs" style="display: none;">
                        <div class="ssa-form-group">
                            <label for="ssa-sync-team" class="ssa-label">Team</label>
                            <select id="ssa-sync-team" name="team_id" class="ssa-select">
                                <option value="">Select a team...</option>
                            </select>
                            <p class="ssa-form-help">Don't see your team? <button type="button" id="ssa-discover-btn" class="ssa-link-btn">Discover Teams</button></p>
                        </div>
                    </div>

                    <div class="ssa-form-group">
                        <code id="ssa-sync-preview" class="ssa-code ssa-code--preview">flask sports-admin sync --league NBA --start 2026-02-19 --days 7</code>
                    </div>
                    <button type="submit" id="ssa-sync-btn" class="ssa-btn ssa-btn--primary">Run Sync</button>
                </form>
            </div>
            <div class="ssa-grid-card ssa-grid-card--danger">
                <h3 class="ssa-grid-card-title ssa-grid-card-title--danger">Clear League Data</h3>
                <p class="ssa-grid-card-desc">Permanently delete data for a league. Leave dates empty to clear all, or specify a range.</p>
                <form id="ssa-clear-form" class="ssa-form">
                    <div class="ssa-form-group">
                        <label for="ssa-clear-league" class="ssa-label">League</label>
                        <select id="ssa-clear-league" name="league" class="ssa-select" required>
                            {% for code, label in leagues %}
                            <option value="{{ code }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="ssa-form-group">
                        <label for="ssa-clear-start" class="ssa-label">Start Date (optional)</label>
                        <input type="date" id="ssa-clear-start" name="start_date" class="ssa-input" placeholder="Leave empty for all dates">
                    </div>
                    <div class="ssa-form-row">
                        <div class="ssa-form-group ssa-form-group--flex">
                            <label for="ssa-clear-end" class="ssa-label">End Date (optional)</label>
                            <input type="date" id="ssa-clear-end" name="end_date" class="ssa-input">
                        </div>
                        <span class="ssa-form-or">or</span>
                        <div class="ssa-form-group ssa-form-group--flex">
                            <label for="ssa-clear-days" class="ssa-label">Days</label>
                            <input type="number" id="ssa-clear-days" name="days" class="ssa-input" min="1" placeholder="From start">
                        </div>
                    </div>
                    <div class="ssa-form-group">
                        <code id="ssa-clear-preview" class="ssa-code ssa-code--preview">flask sports-admin clear-league --league NBA</code>
                    </div>
                    <div class="ssa-form-group">
                        <label for="ssa-clear-confirm" class="ssa-label">Type league code to confirm</label>
                        <input type="text" id="ssa-clear-confirm" name="confirm" class="ssa-input" placeholder="e.g. NBA" autocomplete="off">
                    </div>
                    <button type="submit" id="ssa-clear-btn" class="ssa-btn ssa-btn--danger" disabled>Clear Data</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Logs Panel -->
    <div id="panel-logs" class="ssa-panel" role="tabpanel">
        <div class="ssa-card">
            <div class="ssa-card-header">Recent Activity</div>
            <div class="ssa-card-body" style="padding: 0;">
                <div id="logs-table-container">
                    <div class="ssa-spinner">
                        <div class="ssa-spinner-icon" aria-hidden="true"></div>
                        <span class="ssa-spinner-text">Loading logs...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Panel -->
    <div id="panel-preview" class="ssa-panel" role="tabpanel">
        <div class="ssa-card">
            <div class="ssa-card-header">Latest 10 Games in DoltHub</div>
            <div class="ssa-card-body" style="padding: 0;">
                <div id="preview-table-container">
                    <div class="ssa-spinner">
                        <div class="ssa-spinner-icon" aria-hidden="true"></div>
                        <span class="ssa-spinner-text">Fetching preview from DoltHub...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // Tab switching (no Bootstrap)
    const tabBtns = document.querySelectorAll('.ssa-tab-btn');
    const panels = document.querySelectorAll('.ssa-panel');

    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = 'panel-' + this.getAttribute('data-ssa-panel');
            tabBtns.forEach(b => b.classList.remove('ssa-tab-btn--active'));
            panels.forEach(p => p.classList.remove('ssa-panel--active'));
            this.classList.add('ssa-tab-btn--active');
            document.getElementById(targetId).classList.add('ssa-panel--active');
        });
    });

    // Load data
    document.addEventListener('DOMContentLoaded', function() {
        initCoverageToggle();
        loadCoverage();
        loadPreview();
        loadLogs();
        initSyncForm();
        initClearForm();
    });

    function getCoverageScope() {
        const active = document.querySelector('.ssa-toggle-btn.ssa-toggle-btn--active[data-ssa-scope]');
        return active ? active.getAttribute('data-ssa-scope') : 'current_season';
    }

    function initCoverageToggle() {
        const btns = document.querySelectorAll('.ssa-toggle-btn[data-ssa-scope]');
        btns.forEach(btn => {
            btn.addEventListener('click', function() {
                if (this.classList.contains('ssa-toggle-btn--active')) return;
                btns.forEach(b => {
                    b.classList.remove('ssa-toggle-btn--active');
                    b.setAttribute('aria-pressed', 'false');
                });
                this.classList.add('ssa-toggle-btn--active');
                this.setAttribute('aria-pressed', 'true');
                const container = document.getElementById('coverage-table-container');
                container.innerHTML = '<div class="ssa-spinner"><div class="ssa-spinner-icon" aria-hidden="true"></div><span class="ssa-spinner-text">Fetching stats from DoltHub...</span></div>';
                loadCoverage();
            });
        });
    }

    function getCsrfToken() {
        const meta = document.querySelector('meta[name="csrf-token"]');
        return meta ? meta.getAttribute('content') : '';
    }

    function showOpMessage(text, isError) {
        const el = document.getElementById('ssa-op-message');
        el.textContent = text;
        el.className = 'ssa-op-message ssa-op-message--' + (isError ? 'error' : 'success');
    }

    function showOpMessageLoading(text) {
        const el = document.getElementById('ssa-op-message');
        el.innerHTML = '<span class="ssa-op-spinner" aria-hidden="true"></span><span>' + text + '</span>';
        el.className = 'ssa-op-message ssa-op-message--loading';
    }

    function initSyncForm() {
        const form = document.getElementById('ssa-sync-form');
        const preview = document.getElementById('ssa-sync-preview');
        const leagueEl = document.getElementById('ssa-sync-league');
        const startEl = document.getElementById('ssa-sync-start');
        const endEl = document.getElementById('ssa-sync-end');
        const daysEl = document.getElementById('ssa-sync-days');
        const btn = document.getElementById('ssa-sync-btn');
        
        const modeGroup = document.getElementById('ssa-sync-mode-group');
        const rangeInputs = document.getElementById('ssa-sync-range-inputs');
        const teamInputs = document.getElementById('ssa-sync-team-inputs');
        const teamEl = document.getElementById('ssa-sync-team');
        const discoverBtn = document.getElementById('ssa-discover-btn');
        const collegeLeagues = {{ college_leagues | tojson }};

        function getActiveMode() {
            const active = modeGroup.querySelector('.ssa-toggle-btn--active');
            return active ? active.getAttribute('data-ssa-mode') : 'range';
        }

        async function updateTeams(league) {
            teamEl.innerHTML = '<option value="">Loading teams...</option>';
            try {
                const res = await fetch("{{ url_for('sports_schedule_admin.get_teams') }}?league=" + encodeURIComponent(league));
                const teams = await res.json();
                if (Array.isArray(teams) && teams.length > 0) {
                    teamEl.innerHTML = '<option value="">Select a team (' + teams.length + ')...</option>' + 
                        teams.map(t => `<option value="${t.espn_team_id}">${t.name} (${t.abbreviation})</option>`).join('');
                } else {
                    teamEl.innerHTML = '<option value="">No teams found. Click "Discover Teams" below.</option>';
                }
            } catch (err) {
                teamEl.innerHTML = '<option value="">Error loading teams</option>';
            }
        }

        function updatePreview() {
            const league = leagueEl.value;
            const mode = getActiveMode();

            if (mode === 'team') {
                const teamId = teamEl.value || '<TEAM_ID>';
                preview.textContent = 'flask sports-admin sync-team --league ' + league + ' --team-id ' + teamId;
            } else {
                const start = startEl.value || 'YYYY-MM-DD';
                const end = endEl.value;
                const days = parseInt(daysEl.value, 10);
                let cmd = 'flask sports-admin sync --league ' + league + ' --start ' + start;
                if (end) cmd += ' --end ' + end;
                else if (days && !isNaN(days) && days >= 1) cmd += ' --days ' + days;
                else cmd += ' --days 7';
                preview.textContent = cmd;
            }
        }

        leagueEl.addEventListener('change', function() {
            const isCollege = collegeLeagues.includes(this.value);
            modeGroup.style.display = isCollege ? 'block' : 'none';
            if (!isCollege) {
                // Reset to range mode if not college
                modeGroup.querySelectorAll('.ssa-toggle-btn').forEach(b => {
                    if (b.getAttribute('data-ssa-mode') === 'range') b.classList.add('ssa-toggle-btn--active');
                    else b.classList.remove('ssa-toggle-btn--active');
                });
                rangeInputs.style.display = 'block';
                teamInputs.style.display = 'none';
                startEl.required = true;
            } else if (getActiveMode() === 'team') {
                updateTeams(this.value);
            }
            updatePreview();
        });

        modeGroup.querySelectorAll('.ssa-toggle-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                modeGroup.querySelectorAll('.ssa-toggle-btn').forEach(b => b.classList.remove('ssa-toggle-btn--active'));
                this.classList.add('ssa-toggle-btn--active');
                const mode = this.getAttribute('data-ssa-mode');
                rangeInputs.style.display = mode === 'range' ? 'block' : 'none';
                teamInputs.style.display = mode === 'team' ? 'block' : 'none';
                startEl.required = mode === 'range';
                if (mode === 'team') updateTeams(leagueEl.value);
                updatePreview();
            });
        });

        discoverBtn.addEventListener('click', async function() {
            this.disabled = true;
            const originalText = this.textContent;
            this.textContent = 'Discovering...';
            showOpMessageLoading('Discovering teams for ' + leagueEl.value + '...');
            try {
                const res = await fetch("{{ url_for('sports_schedule_admin.api_sync_teams') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                    body: JSON.stringify({ league: leagueEl.value })
                });
                const data = await res.json();
                if (data.success) {
                    showOpMessage(data.message, false);
                    updateTeams(leagueEl.value);
                } else {
                    showOpMessage(data.error || 'Discovery failed', true);
                }
            } catch (err) {
                showOpMessage('Network error: ' + err.message, true);
            }
            this.disabled = false;
            this.textContent = originalText;
        });

        startEl.addEventListener('change', updatePreview);
        endEl.addEventListener('change', updatePreview);
        daysEl.addEventListener('input', updatePreview);
        teamEl.addEventListener('change', updatePreview);

        if (!startEl.value) {
            startEl.value = new Date().toISOString().slice(0, 10);
        }
        
        // Initial state check
        if (collegeLeagues.includes(leagueEl.value)) {
            modeGroup.style.display = 'block';
        }
        updatePreview();

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const mode = getActiveMode();
            if (mode === 'team' && !teamEl.value) {
                showOpMessage('Please select a team', true);
                return;
            }

            btn.disabled = true;
            showOpMessageLoading('Syncing...');
            try {
                let body, url;
                if (mode === 'team') {
                    url = "{{ url_for('sports_schedule_admin.api_sync') }}"; // We will update api_sync or add api_sync_team
                    body = { league: leagueEl.value, team_id: teamEl.value, mode: 'team' };
                } else {
                    url = "{{ url_for('sports_schedule_admin.api_sync') }}";
                    body = { league: leagueEl.value, start_date: startEl.value };
                    const endVal = endEl.value;
                    const daysNum = parseInt(daysEl.value, 10);
                    if (endVal) body.end_date = endVal;
                    else if (daysNum && !isNaN(daysNum) && daysNum >= 1) body.days = daysNum;
                    else body.days = 7;
                }

                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (data.success) {
                    showOpMessage(data.message, false);
                    loadCoverage();
                    loadPreview();
                    loadLogs();
                } else {
                    showOpMessage(data.error || 'Sync failed', true);
                }
            } catch (err) {
                showOpMessage('Network error: ' + err.message, true);
            }
            btn.disabled = false;
        });
    }

    function initClearForm() {
        const form = document.getElementById('ssa-clear-form');
        const preview = document.getElementById('ssa-clear-preview');
        const leagueEl = document.getElementById('ssa-clear-league');
        const startEl = document.getElementById('ssa-clear-start');
        const endEl = document.getElementById('ssa-clear-end');
        const daysEl = document.getElementById('ssa-clear-days');
        const confirmEl = document.getElementById('ssa-clear-confirm');
        const btn = document.getElementById('ssa-clear-btn');

        function updatePreview() {
            const league = leagueEl.value;
            const start = startEl.value;
            const end = endEl.value;
            const days = parseInt(daysEl.value, 10);
            let cmd = 'flask sports-admin clear-league --league ' + league;
            if (start) {
                cmd += ' --start ' + start;
                if (end) cmd += ' --end ' + end;
                else if (days && !isNaN(days) && days >= 1) cmd += ' --days ' + days;
            }
            preview.textContent = cmd;
        }

        function checkConfirm() {
            btn.disabled = confirmEl.value.trim().toUpperCase() !== leagueEl.value;
        }

        leagueEl.addEventListener('change', function() { updatePreview(); checkConfirm(); });
        startEl.addEventListener('change', updatePreview);
        endEl.addEventListener('input', updatePreview);
        endEl.addEventListener('change', updatePreview);
        daysEl.addEventListener('input', updatePreview);
        confirmEl.addEventListener('input', checkConfirm);

        updatePreview();

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            btn.disabled = true;
            showOpMessageLoading('Clearing...');
            try {
                const body = { league: leagueEl.value, confirm: confirmEl.value.trim() };
                const startVal = document.getElementById('ssa-clear-start').value;
                const endVal = document.getElementById('ssa-clear-end').value;
                const daysVal = document.getElementById('ssa-clear-days').value;
                if (startVal) body.start_date = startVal;
                if (endVal) body.end_date = endVal;
                const daysNum = parseInt(daysVal, 10);
                if (daysVal && !isNaN(daysNum) && daysNum >= 1) body.days = daysNum;

                const res = await fetch("{{ url_for('sports_schedule_admin.api_clear_league') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (data.success) {
                    showOpMessage(data.message, false);
                    confirmEl.value = '';
                    checkConfirm();
                    loadCoverage();
                    loadPreview();
                    loadLogs();
                } else {
                    showOpMessage(data.error || 'Clear failed', true);
                    btn.disabled = false;
                }
            } catch (err) {
                showOpMessage('Network error: ' + err.message, true);
                btn.disabled = false;
            }
        });
    }

    async function loadCoverage() {
        const container = document.getElementById('coverage-table-container');
        const statusEl = document.getElementById('connection-status');
        const scope = getCoverageScope();

        try {
            const response = await fetch("{{ url_for('sports_schedule_admin.get_coverage') }}?scope=" + encodeURIComponent(scope));
            const data = await response.json();

            if (data.error) {
                container.innerHTML = '<div class="ssa-alert ssa-alert--danger">Error: ' + data.error + '</div>';
                statusEl.innerHTML = '<span class="ssa-status-badge ssa-status-badge--error">DoltHub Error</span>';
                return;
            }

            statusEl.innerHTML = '<span class="ssa-status-badge ssa-status-badge--connected">DoltHub Connected</span>';

            const rows = Array.isArray(data) ? data : [];
            let html = '<div class="ssa-table-wrap"><table class="ssa-table"><thead><tr><th>League</th><th>Sport</th><th>Range</th><th class="ssa-cell--end">Total Games</th></tr></thead><tbody>';
            if (rows.length === 0) {
                html += '<tr><td colspan="4" class="ssa-empty">No data for this scope.</td></tr>';
            } else {
                rows.forEach(row => {
                    html += '<tr><td><strong>' + row.league + '</strong></td><td><span class="ssa-badge ssa-badge--sport">' + row.sport + '</span></td><td class="ssa-cell--muted">' + row.start_date + ' to ' + row.end_date + '</td><td class="ssa-cell--end">' + parseInt(row.count).toLocaleString() + '</td></tr>';
                });
            }
            html += '</tbody></table></div>';
            container.innerHTML = html;

        } catch (error) {
            container.innerHTML = '<div class="ssa-alert ssa-alert--danger">Network error: ' + error.message + '</div>';
            statusEl.innerHTML = '<span class="ssa-status-badge ssa-status-badge--error">DoltHub Error</span>';
        }
    }

    async function loadPreview() {
        const container = document.getElementById('preview-table-container');

        try {
            const response = await fetch("{{ url_for('sports_schedule_admin.get_preview') }}");
            const data = await response.json();

            if (data.error) {
                container.innerHTML = '<div class="ssa-alert ssa-alert--danger">Error: ' + data.error + '</div>';
                return;
            }

            let html = '<div class="ssa-table-wrap"><table class="ssa-table"><thead><tr><th>Date</th><th>League</th><th>Matchup</th><th>Time (ET)</th><th>Location</th></tr></thead><tbody>';
            data.forEach(game => {
                html += '<tr><td class="ssa-cell--muted">' + game.date + '</td><td><span class="ssa-badge ssa-badge--league">' + game.league + '</span></td><td>' + game.road_team + ' @ ' + game.home_team + '</td><td class="ssa-cell--muted">' + (game.time || 'N/A') + '</td><td class="ssa-cell--muted">' + (game.location || '') + '</td></tr>';
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;

        } catch (error) {
            container.innerHTML = '<div class="ssa-alert ssa-alert--danger">Network error: ' + error.message + '</div>';
        }
    }

    async function loadLogs() {
        const container = document.getElementById('logs-table-container');
        try {
            const response = await fetch("{{ url_for('sports_schedule_admin.get_logs') }}");
            const data = await response.json();
            let html = '<div class="ssa-table-wrap"><table class="ssa-table"><thead><tr><th>Time</th><th>Actor</th><th>Action</th><th>Description</th></tr></thead><tbody>';
            if (data.length === 0) {
                html += '<tr><td colspan="4" class="ssa-empty">No recent activity found.</td></tr>';
            } else {
                data.forEach(log => {
                    html += '<tr><td class="ssa-cell--muted">' + log.timestamp + '</td><td>' + log.actor + '</td><td><span class="ssa-badge ssa-badge--action">' + log.category + '</span></td><td>' + log.description + '</td></tr>';
                });
            }
            html += '</tbody></table></div>';
            container.innerHTML = html;
        } catch (error) {
            container.innerHTML = '<div class="ssa-alert ssa-alert--danger">Network error: ' + error.message + '</div>';
        }
    }
})();
</script>
{% endblock %}
