{% extends 'base.html' %}

{% block title %}My Signups - Better Signups{% endblock %}

{% block styles %}
<link
  rel="stylesheet"
  href="{{ url_for('better_signups.static', filename='better_signups/styles.css') }}"
/>
{% endblock %}

{% block content %}

<div class="auth-page-container">
    <div class="auth-card">
        <div class="auth-header">
            <h1 class="auth-title">My Signups</h1>
            <p class="auth-subtitle">All your active signups across all lists</p>
        </div>

        {# Pending Confirmations Section - show at top if any exist #}
        {% if pending_confirmations %}
        <div style="margin-top: 2rem; padding: 1.5rem; background-color: #d4edda; border: 2px solid #28a745; border-radius: 8px;">
            <h2 style="color: #155724; margin-bottom: 1rem; font-size: 1.25rem;">
                ‚è± Spots Waiting for Your Confirmation ({{ pending_confirmations|length }})
            </h2>
            <p style="color: #155724; font-size: 0.875rem; margin-bottom: 1rem;">
                You have been offered spot(s) from the waitlist! Please confirm or decline within 24 hours.
            </p>
            
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                {% for pending in pending_confirmations %}
                <div style="padding: 1rem; background-color: white; border-radius: 6px; border-left: 4px solid #ffc107;">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 0.25rem;">
                                {{ pending.family_member.display_name }}
                            </div>
                            <div style="color: #666; font-size: 0.875rem; margin-bottom: 0.25rem;">
                                {% if pending.event %}
                                    List: {{ pending.event.list.name }}
                                {% else %}
                                    List: {{ pending.item.list.name }}
                                {% endif %}
                            </div>
                            <div style="color: #666; font-size: 0.875rem; margin-bottom: 0.25rem;">
                                {% if pending.event %}
                                    {% if pending.event.event_type == 'date' %}
                                        Event: {{ pending.event.event_date.strftime('%B %d, %Y') }}
                                    {% else %}
                                        Event: {{ pending.event.event_datetime.strftime('%B %d, %Y at %I:%M %p') }}
                                    {% endif %}
                                    {% if pending.event.location %}
                                        <br>Location: {{ pending.event.location }}
                                    {% endif %}
                                {% else %}
                                    Item: {{ pending.item.name }}
                                    {% if pending.item.description %}
                                        <br>{{ pending.item.description }}
                                    {% endif %}
                                {% endif %}
                            </div>
                            <div style="{% if pending.is_expired %}color: #dc3545{% else %}color: #856404{% endif %}; font-weight: bold; font-size: 0.875rem; margin-top: 0.5rem;">
                                {% if pending.is_expired %}
                                    ‚ö†Ô∏è This offer has expired
                                {% else %}
                                    Confirm by: {{ pending.deadline.strftime('%B %d, %Y at %I:%M %p') }}
                                {% endif %}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            {% if not pending.is_expired %}
                                <form method="POST" 
                                      action="{{ url_for('better_signups.confirm_signup', 
                                                uuid=(pending.event.list.uuid if pending.event else pending.item.list.uuid), 
                                                signup_id=pending.id) }}" 
                                      style="display: inline; margin: 0;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" 
                                            class="better-signups-btn"
                                            style="background-color: #28a745; padding: 0.5rem 1rem;">
                                        ‚úì Confirm Your Spot
                                    </button>
                                </form>
                                <form method="POST" 
                                      action="{{ url_for('better_signups.decline_signup', 
                                                uuid=(pending.event.list.uuid if pending.event else pending.item.list.uuid), 
                                                signup_id=pending.id) }}" 
                                      style="display: inline; margin: 0;"
                                      onsubmit="return confirm('Decline this spot? It will be offered to the next person on the waitlist.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" 
                                            class="better-signups-btn better-signups-btn-danger"
                                            style="padding: 0.5rem 1rem;">
                                        Decline
                                    </button>
                                </form>
                            {% else %}
                                <span style="color: #dc3545; font-size: 0.875rem;">Expired - will be offered to next person</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if signups %}
        <div style="margin-top: 2rem;">
            {# Filter input #}
            <div style="margin-bottom: 1rem;">
                <input type="text" 
                       id="signup-filter" 
                       placeholder="Filter by list name, description, or item/event name..." 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.875rem;"
                       onkeyup="filterSignups()">
            </div>
            
            {# Group signups by list #}
            {% set grouped_signups = {} %}
            {% for signup in signups %}
                {% set list_name = signup.event.list.name if signup.event else signup.item.list.name %}
                {% if list_name not in grouped_signups %}
                    {% set _ = grouped_signups.update({list_name: []}) %}
                {% endif %}
                {% set _ = grouped_signups[list_name].append(signup) %}
            {% endfor %}
            
            <div id="signups-container">
                {% for list_name in grouped_signups.keys()|sort %}
                {% set first_signup = grouped_signups[list_name][0] %}
                {% set list_uuid = first_signup.event.list.uuid if first_signup.event else first_signup.item.list.uuid %}
                <div class="signup-list-group" data-list-name="{{ list_name|lower }}" data-list-description="{{ (first_signup.event.list.description if first_signup.event else first_signup.item.list.description)|default('')|lower }}">
                    <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 2px solid #ddd;">
                        <a href="{{ url_for('better_signups.view_list', uuid=list_uuid) }}" style="color: #007bff; text-decoration: none;">{{ list_name }}</a>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem;">
                        {% for signup in grouped_signups[list_name] %}
                        {% set signup_list_name = signup.event.list.name if signup.event else signup.item.list.name %}
                        <div class="signup-item" 
                             data-list-name="{{ signup_list_name|lower }}"
                             data-list-description="{{ (signup.event.list.description if signup.event else signup.item.list.description)|default('')|lower }}"
                             data-element-name="{% if signup.event %}{% if signup.event.event_type == 'date' %}{{ signup.event.event_date.strftime('%B %d, %Y')|lower }}{% else %}{{ signup.event.event_datetime.strftime('%B %d, %Y at %I:%M %p')|lower }}{% endif %}{% else %}{{ signup.item.name|lower }}{% endif %}"
                             data-element-description="{% if signup.event %}{{ (signup.event.description or '')|lower }}{% else %}{{ (signup.item.description or '')|lower }}{% endif %}">
                <div style="padding: 1rem; background-color: #f9f9f9; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                        <div style="flex: 1; min-width: 250px;">
                            <div style="color: #666; font-size: 0.875rem; margin-bottom: 0.5rem;">
                                {% if signup.event %}
                                    <div style="font-weight: bold; color: #333; margin-bottom: 0.25rem;">
                                        {% if signup.event.event_type == 'date' %}
                                            {{ signup.event.event_date.strftime('%B %d, %Y') }}
                                        {% else %}
                                            {% set end_time = signup.event.get_end_datetime() %}
                                            <div>
                                                <div>
                                                    <strong>Start:</strong> {{ signup.event.event_datetime.strftime('%B %d, %Y at %I:%M %p') }}
                                                </div>
                                                {% if end_time %}
                                                <div>
                                                    <strong>End:</strong> {{ end_time.strftime('%B %d, %Y at %I:%M %p') }}
                                                </div>
                                                {% endif %}
                                                <div style="color: #666; font-weight: normal; font-size: 0.8rem; margin-top: 0.25rem;">
                                                    Timezone: {{ signup.event.timezone }}
                                                    {% if signup.event.duration_minutes %}
                                                        | Duration: {{ signup.event.duration_minutes }} minutes
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                    {% if signup.event.description %}
                                    <div style="margin-top: 0.25rem;">
                                        {{ signup.event.description }}
                                    </div>
                                    {% endif %}
                                    {% if signup.event.location %}
                                    <div style="margin-top: 0.25rem;">
                                        üìç {% if signup.event.location_is_link %}
                                            <a href="https://www.google.com/maps?q={{ signup.event.location|urlencode }}" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: none;">{{ signup.event.location }}</a>
                                        {% else %}
                                            {{ signup.event.location }}
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                {% else %}
                                    <div style="font-weight: bold; color: #333;">
                                        {{ signup.item.name }}
                                    </div>
                                    {% if signup.item.description %}
                                    <div style="margin-top: 0.25rem;">
                                        {{ signup.item.description }}
                                    </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                            
                            <div style="color: #666; font-size: 0.875rem; margin-top: 0.5rem;">
                                <strong>Signed up:</strong> {{ signup.family_member.display_name }}
                                {% if not signup.family_member.is_self %}
                                    (via {{ signup.user.full_name }})
                                {% endif %}
                            </div>
                            
                            <div style="color: #999; font-size: 0.75rem; margin-top: 0.5rem;">
                                Signed up on {{ signup.created_at.strftime('%B %d, %Y') }}
                            </div>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                            {% if signup.google_calendar_url %}
                            <a href="{{ signup.google_calendar_url }}" 
                               target="_blank" 
                               rel="noopener noreferrer"
                               style="background-color: #4285F4; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block; text-align: center;">
                                üìÖ Add to Google Calendar
                            </a>
                            {% endif %}
                            {% if signup.pending_swap_request %}
                            <div style="display: flex; flex-direction: column; gap: 0.25rem; align-items: flex-end;">
                                <div style="background-color: #ffc107; color: #333; padding: 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-align: right; max-width: 200px;">
                                    üîÑ Swap Requested
                                    <div style="font-weight: normal; margin-top: 0.25rem; font-size: 0.7rem;">
                                        Swapping to:
                                        {% for target_desc in signup.swap_target_descriptions %}
                                            <div>‚Ä¢ {{ target_desc }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <form method="POST" 
                                      action="{{ url_for('better_signups.cancel_swap_request', swap_request_id=signup.pending_swap_request.id) }}" 
                                      style="margin: 0;"
                                      onsubmit="return confirm('Cancel this swap request? All swap links will be invalidated.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" 
                                            style="background-color: #6c757d; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                        Cancel Swap
                                    </button>
                                </form>
                            </div>
                            {% elif signup.has_eligible_swap_targets %}
                            <a href="{{ url_for('better_signups.create_swap_request', signup_id=signup.id) }}" 
                               class="better-signups-btn better-signups-btn-secondary"
                               style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                                üîÑ Swap
                            </a>
                            {% endif %}
                            <form method="POST" 
                                  action="{{ url_for('better_signups.cancel_signup', uuid=signup.event.list.uuid if signup.event else signup.item.list.uuid, signup_id=signup.id) }}" 
                                  style="margin: 0;" 
                                  onsubmit="return confirm('Are you sure you want to cancel this signup?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="next" value="{{ url_for('better_signups.my_signups') }}"/>
                                <button type="submit" 
                                        style="background-color: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; cursor: pointer;">
                                    Cancel Signup
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div style="margin-top: 2rem; text-align: center; padding: 2rem; color: #666;">
            <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">You haven't signed up for anything yet.</p>
            <p style="font-size: 0.875rem;">When you sign up for events or items, they'll appear here.</p>
        </div>
        {% endif %}

        {# Lottery Entries Section #}
        {% if lottery_lists %}
        <div style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid #e0e0e0;">
            <h2 style="font-size: 1.25rem; margin-bottom: 1rem;">
                üé≤ My Lottery Entries
                {% set total_entries = lottery_lists|map(attribute='entries')|map('length')|sum %}
                <span style="font-size: 0.875rem; color: #666; font-weight: normal;">
                    ({{ total_entries }} {% if total_entries == 1 %}entry{% else %}entries{% endif %} across {{ lottery_lists|length }} {% if lottery_lists|length == 1 %}lottery{% else %}lotteries{% endif %})
                </span>
            </h2>
            <p style="color: #666; font-size: 0.875rem; margin-bottom: 1.5rem;">
                These are your entries for lotteries that haven't run yet. You can remove entries until the lottery runs.
            </p>

            {% for list_data in lottery_lists %}
            {% set list_obj = list_data['list'] %}
            {% set lottery_datetime_local = list_data['lottery_datetime_local'] %}
            {% set entries = list_data['entries'] %}

            <div style="margin-bottom: 2rem; padding: 1.5rem; background-color: #f0f8ff; border-radius: 8px; border-left: 4px solid #007bff;">
                {# List header #}
                <div style="margin-bottom: 1rem;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">
                        <a href="{{ url_for('better_signups.view_list', uuid=list_obj.uuid) }}"
                           style="color: #007bff; text-decoration: none;">
                            {{ list_obj.name }}
                        </a>
                    </h3>
                    <div style="font-weight: bold; color: #004085; font-size: 0.9rem; margin-bottom: 0.25rem;">
                        üìÖ Lottery: {{ lottery_datetime_local.strftime('%B %d, %Y at %I:%M %p') }} {{ list_obj.lottery_timezone }}
                    </div>
                    {% if list_obj.lottery_running %}
                    <div style="color: #856404; font-weight: bold; font-size: 0.875rem; margin-top: 0.5rem;">
                        ‚è≥ Lottery is currently running...
                    </div>
                    {% endif %}
                </div>

                {# Entries for this list #}
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    {% for entry in entries %}
                    {% set element = entry.event if entry.event_id else entry.item %}
                    <div style="padding: 1rem; background-color: white; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div style="flex: 1; min-width: 250px;">
                            <div style="font-weight: bold; margin-bottom: 0.25rem; color: #333;">
                                {{ entry.family_member.display_name }}
                            </div>
                            <div style="color: #666; font-size: 0.875rem;">
                                {% if entry.event %}
                                    {% if entry.event.event_type == 'date' %}
                                        üìÖ {{ entry.event.event_date.strftime('%B %d, %Y') }}
                                    {% else %}
                                        üìÖ {{ entry.event.event_datetime.strftime('%B %d, %Y at %I:%M %p') }}
                                    {% endif %}
                                    {% if entry.event.location %}
                                        <br>üìç {{ entry.event.location }}
                                    {% endif %}
                                {% else %}
                                    üì¶ {{ entry.item.name }}
                                    {% if entry.item.description %}
                                        <br><span style="color: #999; font-size: 0.8rem;">{{ entry.item.description }}</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            {% if not list_obj.lottery_running %}
                            <form method="POST"
                                  action="{{ url_for('better_signups.remove_lottery_entry', uuid=list_obj.uuid, entry_id=entry.id) }}"
                                  style="margin: 0;"
                                  onsubmit="return confirm('Remove {{ entry.family_member.display_name }} from this lottery?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="next" value="{{ url_for('better_signups.my_signups') }}"/>
                                <button type="submit"
                                        class="better-signups-btn better-signups-btn-danger"
                                        style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                                    Remove Entry
                                </button>
                            </form>
                            {% else %}
                            <span style="color: #856404; font-size: 0.875rem;">Cannot remove during lottery</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {# Waitlist Section #}
        {% if waitlist_entries %}
        <div style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid #e0e0e0;">
            <h2 style="font-size: 1.25rem; margin-bottom: 1rem;">Waitlists You're On</h2>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                {% for entry in waitlist_entries %}
                {% set element = entry.get_element() %}
                {% if element %}
                <div style="padding: 1rem; background-color: #fff9e6; border-radius: 8px; border-left: 4px solid #f39c12;">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                        <div style="flex: 1; min-width: 250px;">
                            <div style="color: #666; font-size: 0.875rem; margin-bottom: 0.5rem;">
                                <div style="font-weight: bold; color: #f39c12; margin-bottom: 0.25rem; font-size: 0.9rem;">
                                    üìã Waitlist Position #{{ entry.current_position }}
                                </div>
                                <div style="font-weight: bold; color: #333; margin-bottom: 0.25rem;">
                                    {{ entry.signup_list.name }}
                                </div>
                                {% if entry.element_type == 'event' %}
                                    <div style="margin-top: 0.5rem;">
                                        {% if element.event_type == 'date' %}
                                            {{ element.event_date.strftime('%B %d, %Y') }}
                                        {% else %}
                                            {{ element.event_datetime.strftime('%B %d, %Y at %I:%M %p') }}
                                            {% if element.timezone %}
                                                <span style="font-size: 0.8rem;">({{ element.timezone }})</span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    {% if element.location %}
                                    <div style="margin-top: 0.25rem;">
                                        üìç {{ element.location }}
                                    </div>
                                    {% endif %}
                                {% else %}
                                    <div style="margin-top: 0.5rem;">
                                        {{ element.name }}
                                    </div>
                                    {% if element.description %}
                                    <div style="margin-top: 0.25rem; color: #666;">
                                        {{ element.description }}
                                    </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                            
                            <div style="color: #666; font-size: 0.875rem; margin-top: 0.5rem;">
                                <strong>Family member:</strong> {{ entry.family_member.display_name }}
                            </div>
                            
                            <div style="color: #999; font-size: 0.75rem; margin-top: 0.5rem;">
                                Joined waitlist on {{ entry.created_at.strftime('%B %d, %Y') }}
                            </div>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                            <a href="{{ url_for('better_signups.view_list', uuid=entry.signup_list.uuid) }}" 
                               style="background-color: #007bff; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block;">
                                View List
                            </a>
                            <form method="POST" 
                                  action="{{ url_for('better_signups.remove_from_waitlist', uuid=entry.signup_list.uuid, entry_id=entry.id) }}" 
                                  style="margin: 0;" 
                                  onsubmit="return confirm('Remove {{ entry.family_member.display_name }} from the waitlist?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="next" value="{{ url_for('better_signups.my_signups') }}"/>
                                <button type="submit" 
                                        style="background-color: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; cursor: pointer;">
                                    Remove from Waitlist
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="auth-footer" style="margin-top: 2rem;">
            <p class="auth-footer-text">
                <a href="{{ url_for('better_signups.index') }}" class="auth-link">‚Üê Back to Better Signups</a>
            </p>
        </div>
    </div>
</div>

{% block scripts %}
<script>
function filterSignups() {
    const filterValue = document.getElementById('signup-filter').value.toLowerCase().trim();
    const listGroups = document.querySelectorAll('.signup-list-group');
    
    if (filterValue === '') {
        // Show all
        listGroups.forEach(group => {
            group.style.display = '';
            group.querySelectorAll('.signup-item').forEach(item => {
                item.style.display = '';
            });
        });
        return;
    }
    
    // For each list group, filter its items and show/hide the group accordingly
    listGroups.forEach(group => {
        const items = group.querySelectorAll('.signup-item');
        let hasVisibleItems = false;
        
        items.forEach(item => {
            const listName = (item.getAttribute('data-list-name') || '').toLowerCase();
            const listDescription = (item.getAttribute('data-list-description') || '').toLowerCase();
            const elementName = (item.getAttribute('data-element-name') || '').toLowerCase();
            const elementDescription = (item.getAttribute('data-element-description') || '').toLowerCase();
            
            const matches = listName.includes(filterValue) || 
                           listDescription.includes(filterValue) || 
                           elementName.includes(filterValue) ||
                           elementDescription.includes(filterValue);
            
            if (matches) {
                item.style.display = '';
                hasVisibleItems = true;
            } else {
                item.style.display = 'none';
            }
        });
        
        // Show the group only if it has at least one visible item
        group.style.display = hasVisibleItems ? '' : 'none';
    });
}
</script>
{% endblock %}

{% endblock %}



