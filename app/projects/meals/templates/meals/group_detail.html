{% extends "base.html" %}

{% block title %}{{ group.name }}{% endblock %}

{% block content %}
<div class="meals-container">
    <div class="meals-nav">
        <a href="{{ url_for('meals.index') }}" class="meals-back-link">&larr; Back to Dashboard</a>
    </div>

    <div class="meals-header">
        <h1 class="meals-title">{{ group.name }}</h1>
        <div class="meals-actions">
            <a href="{{ url_for('meals.calendar_view', group_id=group.id) }}" class="meals-button meals-button-info">View Calendar</a>
            <a href="#log-meal" class="meals-button">Log a Meal</a>
        </div>
    </div>

    <div class="meals-section" id="log-meal">
        <div class="meals-card meals-log-card">
            <h2>Log a Meal</h2>
            <form action="{{ url_for('meals.log_meal', group_id=group.id) }}" method="POST" novalidate>
                {{ log_form.hidden_tag() }}
                <div class="meals-form-row">
                    <div class="meals-form-group">
                        {{ log_form.date.label }}
                        {{ log_form.date(class="meals-input", type="date") }}
                    </div>
                    <div class="meals-form-group">
                        {{ log_form.meal_type.label }}
                        {{ log_form.meal_type(class="meals-input") }}
                    </div>
                </div>
                
                <div class="meals-form-group">
                    {{ log_form.food_name.label }}
                    {{ log_form.food_name(class="meals-input", placeholder="e.g., Pizza and Salad", list="food-suggestions") }}
                    <datalist id="food-suggestions"></datalist>
                </div>
                
                <div class="meals-form-group">
                    {{ log_form.location.label }}
                    {{ log_form.location(class="meals-input", placeholder="e.g., Home or Restaurant Name", list="location-suggestions") }}
                    <datalist id="location-suggestions"></datalist>
                </div>

                <div class="meals-form-group">
                    <div class="meals-label-row">
                        <label>Who ate this?</label>
                        <div class="meals-selection-helpers">
                            <button type="button" class="meals-helper-btn" onclick="selectAllMembers()">Select All</button>
                            <span class="meals-helper-divider">|</span>
                            <button type="button" class="meals-helper-btn" onclick="clearAllMembers()">Clear All</button>
                        </div>
                    </div>
                    <div class="meals-checkbox-group" id="member-checkbox-group">
                        {% for subfield in log_form.member_ids %}
                            <div class="meals-checkbox-item">
                                {{ subfield(required=False) }}
                                {{ subfield.label }}
                            </div>
                        {% endfor %}
                    </div>
                </div>

                {{ log_form.submit(class="meals-button meals-button-primary") }}
            </form>
        </div>
    </div>

    <div class="meals-section">
        <div class="meals-stats-row">
            <div class="meals-stats-card">
                <h2>Common Meals</h2>
                <div class="meals-filter-bar">
                    <form action="{{ url_for('meals.group_detail', group_id=group.id) }}" method="GET" class="meals-inline-form">
                        <select name="member_id" onchange="this.form.submit()" class="meals-input-sm">
                            <option value="">Family View</option>
                            {% for member in group.members %}
                                <option value="{{ member.id }}" {% if member_filter == member.id %}selected{% endif %}>{{ member.display_name }}</option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
                {% if common_meals %}
                    <table class="meals-table">
                        <thead>
                            <tr>
                                <th>Food</th>
                                <th>Location</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for food, loc, count in common_meals %}
                                <tr>
                                    <td>{{ food }}</td>
                                    <td>{{ loc or '-' }}</td>
                                    <td>{{ count }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="meals-empty-text">Not enough data for common meals.</p>
                {% endif %}
            </div>

            <div class="meals-stats-card">
                <h2>Location Trends</h2>
                {% if home_count or out_count %}
                    <div class="meals-trends">
                        <div class="meals-trend-item">
                            <span class="meals-trend-label">Home</span>
                            <div class="meals-trend-bar-container">
                                <div class="meals-trend-bar meals-trend-home" style="width: {{ (home_count / (home_count + out_count) * 100)|round|int if (home_count + out_count) > 0 else 0 }}%"></div>
                            </div>
                            <span class="meals-trend-value">{{ home_count }}</span>
                        </div>
                        <div class="meals-trend-item">
                            <span class="meals-trend-label">Eating Out</span>
                            <div class="meals-trend-bar-container">
                                <div class="meals-trend-bar meals-trend-out" style="width: {{ (out_count / (home_count + out_count) * 100)|round|int if (home_count + out_count) > 0 else 0 }}%"></div>
                            </div>
                            <span class="meals-trend-value">{{ out_count }}</span>
                        </div>
                    </div>
                {% else %}
                    <p class="meals-empty-text">No location data yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="meals-section">
        <div class="meals-history-header">
            <h2>Recent History</h2>
            <button type="button" class="meals-delete-toggle" onclick="toggleDeleteMode(this)">Delete</button>
        </div>
        {% if recent_entries %}
            <div class="meals-history-list" id="meals-history-list">
                {% set last_date = None %}
                {% for entry in recent_entries %}
                    {% if entry.date != last_date %}
                        <div class="meals-history-date-header" data-date="{{ entry.date }}">{{ entry.date.strftime('%A, %B %d') }}</div>
                        {% set last_date = entry.date %}
                    {% endif %}
                    <div class="meals-history-item" id="entry-{{ entry.id }}">
                        <div class="meals-history-main">
                            <span class="meals-history-type">{{ entry.meal_type }}:</span>
                            <span class="meals-history-food">{{ entry.food_name }}</span>
                            {% if entry.location %}
                                <span class="meals-history-location">@ {{ entry.location }}</span>
                            {% endif %}
                        </div>
                        <div class="meals-history-meta">
                            <span class="meals-history-member">{{ entry.member.display_name }}</span>
                            <button type="button" class="meals-entry-delete-btn" onclick="deleteEntry({{ entry.id }}, {{ group.id }})">&times;</button>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="meals-empty">
                <p>No meals logged yet.</p>
            </div>
        {% endif %}
    </div>

    <div class="meals-section">
        <h2>Family Members</h2>
        <div class="meals-members-list">
            {% for member in group.members %}
                <div class="meals-member-item">
                    <span class="meals-member-name">{{ member.display_name }}</span>
                    {% if member.user_id %}
                        <span class="meals-badge">Linked</span>
                    {% else %}
                        <span class="meals-badge meals-badge-guest">Guest</span>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="meals-grid">
        <div class="meals-card">
            <h3>Invite Member</h3>
            <p class="meals-card-desc">Invite someone with an account via email.</p>
            <form action="{{ url_for('meals.invite_member', group_id=group.id) }}" method="POST">
                {{ invite_form.hidden_tag() }}
                <div class="meals-form-group">
                    {{ invite_form.email(class="meals-input", placeholder="email@example.com") }}
                </div>
                {{ invite_form.submit(class="meals-button meals-button-secondary") }}
            </form>
        </div>

        <div class="meals-card">
            <h3>Add Guest</h3>
            <p class="meals-card-desc">Add a member without an account (e.g., a child).</p>
            <form action="{{ url_for('meals.add_guest_member', group_id=group.id) }}" method="POST">
                {{ guest_form.hidden_tag() }}
                <div class="meals-form-group">
                    {{ guest_form.display_name(class="meals-input", placeholder="Name") }}
                </div>
                {{ guest_form.submit(class="meals-button meals-button-secondary") }}
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('meals.static', filename='meals/style.css') }}">
{% endblock %}

{% block scripts %}
<script>
function selectAllMembers() {
    const checkboxes = document.querySelectorAll('#member-checkbox-group input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
}

function clearAllMembers() {
    const checkboxes = document.querySelectorAll('#member-checkbox-group input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
}

// Delete Mode logic
function toggleDeleteMode(btn) {
    const list = document.getElementById('meals-history-list');
    const isDeleting = list.classList.toggle('meals-delete-mode');
    btn.textContent = isDeleting ? 'Done' : 'Delete';
    btn.classList.toggle('meals-delete-active', isDeleting);
}

async function deleteEntry(entryId, groupId) {
    if (!confirm('Delete this entry?')) return;
    
    try {
        const response = await fetch(`/meals/groups/${groupId}/entries/${entryId}/delete`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': "{{ csrf_token() }}",
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const entryRow = document.getElementById(`entry-${entryId}`);
            // Check if this was the last entry under a date header
            const prevHeader = entryRow.previousElementSibling;
            const nextElem = entryRow.nextElementSibling;
            
            entryRow.remove();
            
            // If the header is followed by another header or nothing, remove the header too
            if (prevHeader && prevHeader.classList.contains('meals-history-date-header')) {
                if (!nextElem || nextElem.classList.contains('meals-history-date-header')) {
                    prevHeader.remove();
                }
            }
        } else {
            alert('Failed to delete entry.');
        }
    } catch (e) {
        console.error('Delete failed', e);
        alert('An error occurred.');
    }
}

// Autocomplete logic
async function setupAutocomplete(inputId, datalistId, apiUrl) {
    const input = document.getElementById(inputId);
    const datalist = document.getElementById(datalistId);
    
    // Fetch initial suggestions
    const updateSuggestions = async (query = '') => {
        try {
            const response = await fetch(`${apiUrl}?q=${encodeURIComponent(query)}`);
            const suggestions = await response.json();
            datalist.innerHTML = suggestions
                .map(s => `<option value="${s}">`)
                .join('');
        } catch (e) {
            console.error('Failed to fetch suggestions', e);
        }
    };

    // Update on focus and as typing
    input.addEventListener('focus', () => updateSuggestions(input.value));
    input.addEventListener('input', () => updateSuggestions(input.value));
}

document.addEventListener('DOMContentLoaded', () => {
    setupAutocomplete('food_name', 'food-suggestions', "{{ url_for('meals.suggest_food', group_id=group.id) }}");
    setupAutocomplete('location', 'location-suggestions', "{{ url_for('meals.suggest_location', group_id=group.id) }}");
});
</script>
{% endblock %}
