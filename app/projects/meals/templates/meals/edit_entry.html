{% extends "meals/group_base.html" %}

{% block tab_title %}Edit Entry{% endblock %}

{% block tab_content %}
<div class="meals-section">
    <div class="meals-card meals-log-card">
        <div class="meals-edit-header">
            <h2>Edit Entry</h2>
            <a href="{{ url_for('meals.history_view', group_id=group.id) }}" class="meals-edit-cancel">Cancel</a>
        </div>
        <form action="{{ url_for('meals.edit_entry', group_id=group.id, entry_id=entry.id) }}" method="POST" novalidate>
            {{ edit_form.hidden_tag() }}
            <div class="meals-form-row">
                <div class="meals-form-group">
                    <label for="date">Date <span class="meals-required">*</span></label>
                    {{ edit_form.date(class="meals-input", type="date") }}
                </div>
                <div class="meals-form-group">
                    <label for="meal_type">Meal <span class="meals-required">*</span></label>
                    {{ edit_form.meal_type(class="meals-input") }}
                </div>
            </div>

            <div class="meals-form-group">
                <label for="food_name">Food Name <span class="meals-required">*</span></label>
                {{ edit_form.food_name(class="meals-input", placeholder="e.g., Pizza and Salad", list="food-suggestions", autocomplete="off") }}
                <datalist id="food-suggestions"></datalist>
            </div>

            <div class="meals-form-group">
                <label for="location">Location <span class="meals-required">*</span></label>
                {{ edit_form.location(class="meals-input", placeholder="e.g., Home or Restaurant Name", list="location-suggestions", autocomplete="off") }}
                <datalist id="location-suggestions"></datalist>
            </div>

            <div class="meals-form-group">
                <div class="meals-label-row">
                    <label>Who ate this? <span class="meals-required">*</span></label>
                    <div class="meals-selection-helpers">
                        <button type="button" class="meals-helper-btn" onclick="selectAllEditMembers()">Select All</button>
                        <span class="meals-helper-divider">|</span>
                        <button type="button" class="meals-helper-btn" onclick="clearAllEditMembers()">Clear All</button>
                    </div>
                </div>
                <div class="meals-checkbox-group" id="edit-member-checkbox-group">
                    {% for subfield in edit_form.member_ids %}
                        <div class="meals-checkbox-item">
                            {{ subfield }}
                            {{ subfield.label }}
                        </div>
                    {% endfor %}
                </div>
            </div>

            {{ edit_form.submit(class="meals-button meals-button-primary") }}
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function setupAutocomplete(inputId, datalistId, apiUrl) {
    const input = document.getElementById(inputId);
    const datalist = document.getElementById(datalistId);

    const updateSuggestions = async (query = '') => {
        try {
            const response = await fetch(`${apiUrl}?q=${encodeURIComponent(query)}`);
            const suggestions = await response.json();
            datalist.innerHTML = suggestions
                .map(s => `<option value="${s}">`)
                .join('');
        } catch (e) {
            console.error('Failed to fetch suggestions', e);
        }
    };

    input.addEventListener('focus', () => updateSuggestions(input.value));
    input.addEventListener('input', () => updateSuggestions(input.value));
}

function selectAllEditMembers() {
    const checkboxes = document.querySelectorAll('#edit-member-checkbox-group input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
}

function clearAllEditMembers() {
    const checkboxes = document.querySelectorAll('#edit-member-checkbox-group input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
}

document.addEventListener('DOMContentLoaded', () => {
    setupAutocomplete('food_name', 'food-suggestions', "{{ url_for('meals.suggest_food', group_id=group.id) }}");
    setupAutocomplete('location', 'location-suggestions', "{{ url_for('meals.suggest_location', group_id=group.id) }}");
});
</script>
{% endblock %}
