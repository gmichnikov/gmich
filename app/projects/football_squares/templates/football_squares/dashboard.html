{% extends "football_squares/layout.html" %}

{% block fs_title %}{{ grid.name }} - Dashboard{% endblock %}

{% block fs_content %}
<div class="fs-dashboard-header">
    <div class="fs-grid-meta">
        <h1>{{ grid.name }}</h1>
        <p>{{ grid.team1_name }} (X) vs {{ grid.team2_name }} (Y)</p>
    </div>
    <div class="fs-share-box">
        <label>Shareable Link:</label>
        <div class="fs-copy-input">
            <input type="text" value="{{ url_for('football_squares.public_view', share_slug=grid.share_slug, _external=True) }}" readonly id="shareLink">
            <button onclick="copyLink()" class="fs-btn fs-btn-sm fs-btn-outline">Copy</button>
        </div>
    </div>
</div>

<div class="fs-dashboard-grid">
    <div class="fs-sidebar">
        <!-- Participants Section -->
        <section class="fs-card">
            <div class="fs-card-header">
                <h3>Participants</h3>
                {% if is_locked %}
                <span class="fs-status-pill fs-status-locked" title="Locked: Squares have been assigned">ðŸ”’ Locked</span>
                {% endif %}
            </div>
            
            <ul class="fs-participant-list">
                {% for participant in grid.participants %}
                <li class="fs-participant-item">
                    <div class="fs-participant-info">
                        <span class="fs-participant-name">{{ participant.name }}</span>
                        <span class="fs-participant-count">{{ participant.square_count }} squares</span>
                    </div>
                    <div class="fs-participant-actions">
                        <form action="{{ url_for('football_squares.update_participant', participant_id=participant.id) }}" method="POST" class="fs-participant-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="number" name="square_count" value="{{ participant.square_count }}" min="0" max="100">
                            <button type="submit" class="fs-btn fs-btn-sm fs-btn-outline">âœ“</button>
                        </form>
                        {% if not is_locked %}
                        <form action="{{ url_for('football_squares.delete_participant', participant_id=participant.id) }}" method="POST" style="margin-top: 5px;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="fs-btn fs-btn-sm fs-btn-danger" style="width: 100%;">Remove</button>
                        </form>
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            </ul>

            {% if not is_locked %}
            <form action="{{ url_for('football_squares.add_participant', grid_id=grid.id) }}" method="POST" class="fs-add-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="fs-form-group">
                    <input type="text" name="name" placeholder="Name" required style="width: 100%; margin-bottom: 0.5rem; padding: 0.5rem; border: 1px solid var(--fs-border); border-radius: 4px;">
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="number" name="square_count" placeholder="Squares" value="0" min="0" max="100" style="flex: 1; padding: 0.5rem; border: 1px solid var(--fs-border); border-radius: 4px;">
                        <button type="submit" class="fs-btn fs-btn-primary">Add</button>
                    </div>
                </div>
            </form>
            {% endif %}

            <div class="fs-square-counter">
                <span>Total Allocated:</span>
                <span>{{ total_assigned_squares }}/100</span>
            </div>
            <div class="fs-counter-bar">
                <div class="fs-counter-fill {% if total_assigned_squares > 100 %}full{% endif %}" style="width: {{ total_assigned_squares }}%"></div>
            </div>
            {% if total_assigned_squares > 100 %}
            <p style="color: var(--fs-danger); font-size: 0.8rem; margin-top: 5px;">Warning: More than 100 squares allocated!</p>
            {% endif %}
        </section>

        <!-- Axis Configuration Section -->
        <section class="fs-card">
            <h3>Axis Configuration</h3>
            <div class="fs-axis-config">
                <div class="fs-axis-display">
                    <div class="fs-axis-row">
                        <span class="fs-axis-label">{{ grid.team1_name }} (X):</span>
                        <span class="fs-digits">{{ grid.team1_digits }}</span>
                    </div>
                    <div class="fs-axis-row">
                        <span class="fs-axis-label">{{ grid.team2_name }} (Y):</span>
                        <span class="fs-digits">{{ grid.team2_digits }}</span>
                    </div>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <form action="{{ url_for('football_squares.toggle_axis', grid_id=grid.id) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="fs-btn fs-btn-outline" style="width: 100%;">
                            Switch to {{ "Draft (0-9)" if grid.axis_type.value == "Random" else "Random" }} Mode
                        </button>
                    </form>
                    
                    {% if grid.axis_type.value == "Random" %}
                    <form action="{{ url_for('football_squares.shuffle_axis', grid_id=grid.id) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="fs-btn fs-btn-outline" style="width: 100%;">Re-shuffle Digits</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </section>

        <section class="fs-card">
            <h3>Scoring</h3>
            <p class="fs-placeholder">Scoring management coming in Phase 5.</p>
        </section>
    </div>

    <div class="fs-main-panel">
        <section class="fs-card fs-grid-display">
            <div class="fs-card-header">
                <h3>10x10 Grid</h3>
                <div class="fs-grid-legend">
                    <span class="fs-legend-item"><span class="fs-dot fs-dot-x"></span> {{ grid.team1_name }} (X)</span>
                    <span class="fs-legend-item"><span class="fs-dot fs-dot-y"></span> {{ grid.team2_name }} (Y)</span>
                </div>
            </div>

            <div class="fs-grid-wrapper">
                <table class="fs-squares-table" id="squaresTable">
                    <thead>
                        <tr>
                            <!-- Empty corner spans 2 columns and 2 rows -->
                            <th colspan="2" rowspan="2" style="border: none;"></th>
                            <!-- Team 1 Name Header -->
                            <th colspan="10" class="fs-axis-team-label" style="background: {{ grid.team1_color_primary }}; color: {{ grid.team1_color_secondary }};">
                                {{ grid.team1_name }}
                            </th>
                        </tr>
                        <tr>
                            <!-- Team 1 Digits -->
                            {% set team1_digits = grid.team1_digits.split(',') %}
                            {% for digit in team1_digits %}
                            <th class="fs-axis-digit">{{ digit }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% set team2_digits = grid.team2_digits.split(',') %}
                        {% for y in range(10) %}
                        <tr>
                            {% if loop.first %}
                            <!-- Team 2 Name Sidebar -->
                            <th rowspan="10" class="fs-axis-team-label fs-axis-team-label-y" style="background: {{ grid.team2_color_primary }}; color: {{ grid.team2_color_secondary }};">
                                <span class="fs-axis-vertical">{{ grid.team2_name }}</span>
                            </th>
                            {% endif %}
                            <!-- Team 2 Digit -->
                            <th class="fs-axis-digit">{{ team2_digits[y] }}</th>
                            <!-- Squares -->
                            {% for x in range(10) %}
                                {% set square = squares_map.get((x, y)) %}
                                <td class="fs-square-cell {% if square and square.participant_id %}assigned{% endif %}" 
                                    data-x="{{ x }}" 
                                    data-y="{{ y }}" 
                                    onclick="openAssignmentModal({{ x }}, {{ y }}, '{{ square.participant.name if square and square.participant_id else '' }}', {{ square.participant_id if square and square.participant_id else 'null' }})">
                                    <span class="fs-square-participant">{{ square.participant.name if square and square.participant_id else '' }}</span>
                                </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="fs-grid-actions-bar">
                <form action="{{ url_for('football_squares.randomize_remaining', grid_id=grid.id) }}" method="POST" onsubmit="return confirm('Fill all remaining empty squares randomly?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="fs-btn fs-btn-outline">Fill Remaining Randomly</button>
                </form>
                <form action="{{ url_for('football_squares.randomize_all', grid_id=grid.id) }}" method="POST" onsubmit="return confirm('This will CLEAR all current assignments and randomize the entire grid. Continue?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="fs-btn fs-btn-outline">Randomize All</button>
                </form>
            </div>
        </section>
    </div>
</div>

<!-- Assignment Modal -->
<div id="assignmentModal" class="fs-modal-overlay">
    <div class="fs-modal">
        <h3 id="modalTitle">Assign Square (0,0)</h3>
        <p>Select a participant for this square:</p>
        <select id="participantSelect" class="fs-modal-select">
            <option value="">-- Unassigned --</option>
            {% for participant in grid.participants %}
            <option value="{{ participant.id }}">{{ participant.name }}</option>
            {% endfor %}
        </select>
        <div class="fs-modal-actions" style="display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button onclick="closeAssignmentModal()" class="fs-btn fs-btn-outline fs-btn-sm">Cancel</button>
            <button onclick="saveAssignment()" class="fs-btn fs-btn-primary fs-btn-sm">Save</button>
        </div>
    </div>
</div>

<script>
let currentX = null;
let currentY = null;

function openAssignmentModal(x, y, participantName, participantId) {
    currentX = x;
    currentY = y;
    document.getElementById('modalTitle').textContent = `Assign Square (${x}, ${y})`;
    document.getElementById('participantSelect').value = participantId || "";
    document.getElementById('assignmentModal').style.display = 'flex';
}

function closeAssignmentModal() {
    document.getElementById('assignmentModal').style.display = 'none';
    currentX = null;
    currentY = null;
}

async function saveAssignment() {
    const participantId = document.getElementById('participantSelect').value;
    const response = await fetch(`{{ url_for('football_squares.assign_square', grid_id=grid.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            x: currentX,
            y: currentY,
            participant_id: participantId === "" ? null : participantId
        })
    });

    if (response.ok) {
        window.location.reload(); // Refresh to show changes and update lock status
    } else {
        alert("Failed to save assignment.");
    }
}

function copyLink() {
    var copyText = document.getElementById("shareLink");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(copyText.value);
    alert("Copied to clipboard!");
}
</script>

<style>
.fs-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}
.fs-card-header h3 { margin: 0; }
.fs-status-pill {
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 12px;
    background: #eee;
}
.fs-status-locked {
    background: #fff3f3;
    color: #d32f2f;
    border: 1px solid #ffcdd2;
}
</style>
{% endblock %}
