{% extends "football_squares/layout.html" %}

{% block fs_title %}{{ grid.name }} - Dashboard{% endblock %}

{% block fs_content %}
{% set logo_map = {
    'patriots': 'New_England_Patriots_logo.svg.webp',
    'new england patriots': 'New_England_Patriots_logo.svg.webp',
    'seahawks': 'Seattle_Seahawks_logo.svg.webp',
    'seattle seahawks': 'Seattle_Seahawks_logo.svg.webp'
} %}
<div class="fs-dashboard-header">
    <div class="fs-grid-meta">
        <h1>{{ grid.name }}</h1>
        <p>{{ grid.team1_name }} (X) vs {{ grid.team2_name }} (Y)</p>
    </div>
    <div class="fs-header-actions">
        <button type="button" class="fs-btn fs-btn-outline fs-btn-sm fs-mobile-sidebar-toggle" onclick="toggleSidebar()">
            üìã <span id="sidebarToggleText">Show Sidebar</span>
        </button>
    </div>
</div>

<div class="fs-dashboard-grid">
    <div class="fs-sidebar collapsed" id="fsSidebar">
        <!-- Participants Section -->
        <section class="fs-card">
            <div class="fs-card-header">
                <h3>Participants</h3>
                {% if is_locked %}
                <span class="fs-status-pill fs-status-locked" title="Locked: Squares have been assigned">üîí Locked</span>
                {% endif %}
            </div>
            
            <ul class="fs-participant-list">
                {% for participant in grid.participants %}
                <li class="fs-participant-item">
                    <div class="fs-participant-info">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: {{ participant.color }}; border: 1px solid var(--fs-border);"></div>
                            <span class="fs-participant-name">{{ participant.name }}</span>
                        </div>
                        <span class="fs-participant-count">{{ participant.square_count }} squares</span>
                    </div>
                    <div class="fs-participant-actions">
                        <form action="{{ url_for('football_squares.update_participant', participant_id=participant.id) }}" method="POST" class="fs-participant-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                <div style="display: flex; gap: 0.25rem; align-items: center;">
                                    <input type="number" name="square_count" value="{{ participant.square_count }}" min="0" max="100" style="width: 50px;">
                                    <input type="color" name="color" value="{{ participant.color }}" style="width: 30px; height: 32px; padding: 2px; border: 1px solid var(--fs-border); border-radius: 4px; cursor: pointer;">
                                    <button type="submit" class="fs-btn fs-btn-sm fs-btn-outline">‚úì</button>
                                </div>
                            </div>
                        </form>
                        {% if not is_locked %}
                        <form action="{{ url_for('football_squares.delete_participant', participant_id=participant.id) }}" method="POST" style="margin-top: 5px;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="fs-btn fs-btn-sm fs-btn-danger" style="width: 100%;">Remove</button>
                        </form>
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            </ul>

            {% if not is_locked %}
            <form action="{{ url_for('football_squares.add_participant', grid_id=grid.id) }}" method="POST" class="fs-add-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="fs-form-group">
                    <input type="text" name="name" placeholder="Name" required style="width: 100%; margin-bottom: 0.5rem; padding: 0.5rem; border: 1px solid var(--fs-border); border-radius: 4px;">
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="number" name="square_count" placeholder="Squares" value="0" min="0" max="100" style="flex: 1; padding: 0.5rem; border: 1px solid var(--fs-border); border-radius: 4px;">
                        <button type="submit" class="fs-btn fs-btn-primary">Add</button>
                    </div>
                </div>
            </form>
            {% endif %}

            <div class="fs-square-counter">
                <span>Total Allocated:</span>
                <span>{{ total_assigned_squares }}/100</span>
            </div>
            <div class="fs-counter-bar">
                <div class="fs-counter-fill {% if total_assigned_squares > 100 %}full{% endif %}" style="width: {{ total_assigned_squares }}%"></div>
            </div>
            {% if total_assigned_squares > 100 %}
            <p style="color: var(--fs-danger); font-size: 0.8rem; margin-top: 5px;">Warning: More than 100 squares allocated!</p>
            {% endif %}
        </section>

        <!-- Axis Configuration Section -->
        <section class="fs-card">
            <h3>Axis Configuration</h3>
            <div class="fs-axis-config">
                <div class="fs-axis-display">
                    <div class="fs-axis-row">
                        <span class="fs-axis-label">{{ grid.team1_name }} (X):</span>
                        <span class="fs-digits">{{ grid.team1_digits }}</span>
                    </div>
                    <div class="fs-axis-row">
                        <span class="fs-axis-label">{{ grid.team2_name }} (Y):</span>
                        <span class="fs-digits">{{ grid.team2_digits }}</span>
                    </div>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <form action="{{ url_for('football_squares.toggle_axis', grid_id=grid.id) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="fs-btn fs-btn-outline" style="width: 100%;">
                            Switch to {{ "Draft (0-9)" if grid.axis_type.value == "Random" else "Random" }} Mode
                        </button>
                    </form>
                    
                    {% if grid.axis_type.value == "Random" %}
                    <form action="{{ url_for('football_squares.shuffle_axis', grid_id=grid.id) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="fs-btn fs-btn-outline" style="width: 100%;">Re-shuffle Digits</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- Shareable Link Section -->
        <section class="fs-card">
            <div class="fs-share-box">
                <label>Shareable Link:</label>
                <div class="fs-copy-input">
                    <input type="text" value="{{ url_for('football_squares.public_view', share_slug=grid.share_slug, _external=True) }}" readonly id="shareLink" style="width: 100%;">
                    <button onclick="copyLink()" class="fs-btn fs-btn-sm fs-btn-outline" style="margin-top: 5px; width: 100%;">Copy Link</button>
                </div>
            </div>
        </section>

        <!-- Winnings Summary Section (Removed from here) -->
    </div>

    <div class="fs-main-panel">
        <!-- Scoring & Payouts Section -->
        <section class="fs-card">
            <div class="fs-card-header" style="margin-bottom: 0.5rem;">
                <h3 style="font-size: 1rem;">Scoring & Payouts</h3>
                <button type="button" class="fs-btn fs-btn-outline fs-btn-sm" onclick="toggleScoring()">Show/Hide</button>
            </div>
            
            <div id="scoringCollapsible">
                <form action="{{ url_for('football_squares.update_scores', grid_id=grid.id) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="fs-scoring-table-wrapper">
                        <table class="fs-scoring-table fs-scoring-table-horizontal">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    {% for i in range(1, 6) %}
                                    <th>{{ "OT" if i == 5 else "Q" ~ i }}</th>
                                    {% endfor %}
                                    <th rowspan="4" style="vertical-align: middle; padding-left: 1rem;">
                                        <button type="submit" class="fs-btn fs-btn-primary fs-btn-sm">Update</button>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>{{ grid.team1_name[:10] }}</strong></td>
                                    {% for i in range(1, 6) %}
                                    {% set q = grid.quarters|selectattr('quarter_number', 'equalto', i)|first %}
                                    <td><input type="number" name="q{{ i }}_t1" value="{{ q.team1_score if q.team1_score is not none else '' }}" min="0"></td>
                                    {% endfor %}
                                </tr>
                                <tr>
                                    <td><strong>{{ grid.team2_name[:10] }}</strong></td>
                                    {% for i in range(1, 6) %}
                                    {% set q = grid.quarters|selectattr('quarter_number', 'equalto', i)|first %}
                                    <td><input type="number" name="q{{ i }}_t2" value="{{ q.team2_score if q.team2_score is not none else '' }}" min="0"></td>
                                    {% endfor %}
                                </tr>
                                <tr>
                                    <td><strong>Prize</strong></td>
                                    {% for i in range(1, 6) %}
                                    {% set q = grid.quarters|selectattr('quarter_number', 'equalto', i)|first %}
                                    <td><input type="text" name="q{{ i }}_payout" value="{{ q.payout_description or '' }}" placeholder="Prize"></td>
                                    {% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </form>

                {% if participant_summary %}
                <div class="fs-winner-summary">
                    <h4>Winnings Summary</h4>
                    <div class="fs-summary-grid">
                        {% for name, winnings in participant_summary.items() %}
                        <div class="fs-summary-item">
                            <strong>{{ name }}:</strong> {{ winnings|join(', ') }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </section>

        <!-- Grid Display Section -->
        <section class="fs-card fs-grid-display" style="padding-top: 0.5rem;">
            <div class="fs-grid-wrapper">
                <table class="fs-squares-table" id="squaresTable">
                    <thead>
                        <tr>
                            <!-- Team names now scroll away -->
                            <th colspan="2" style="border: none;"></th>
                            <th colspan="10" class="fs-axis-team-label" style="background: {{ grid.team1_color_primary }}; color: {{ grid.team1_color_secondary }}; border-radius: 4px 4px 0 0;">
                                {{ grid.team1_name }}
                                {% if grid.team1_name.lower() in logo_map %}
                                <img src="{{ url_for('football_squares.static', filename=logo_map[grid.team1_name.lower()]) }}" class="fs-team-logo" alt="{{ grid.team1_name }} logo">
                                {% endif %}
                            </th>
                        </tr>
                        <tr>
                            <!-- Sticky Corner for Digits -->
                            <th colspan="2" class="fs-grid-corner" style="border: none;"></th>
                            <!-- Team 1 Digits -->
                            {% set team1_digits = grid.team1_digits.split(',') %}
                            {% for digit in team1_digits %}
                            <th class="fs-axis-digit">{{ digit }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% set team2_digits = grid.team2_digits.split(',') %}
                        {% for y in range(10) %}
                        <tr>
                            {% if loop.first %}
                            <!-- Team 2 Name Sidebar (Now scrolls away) -->
                            <th rowspan="10" class="fs-axis-team-label fs-axis-team-label-y" style="background: {{ grid.team2_color_primary }}; color: {{ grid.team2_color_secondary }}; border-radius: 4px 0 0 4px;">
                                <span class="fs-axis-vertical">
                                    {{ grid.team2_name }}
                                    {% if grid.team2_name.lower() in logo_map %}
                                    <img src="{{ url_for('football_squares.static', filename=logo_map[grid.team2_name.lower()]) }}" class="fs-team-logo" alt="{{ grid.team2_name }} logo">
                                    {% endif %}
                                </span>
                            </th>
                            {% endif %}
                            <!-- Sticky Y-Axis Digit -->
                            <th class="fs-axis-digit">{{ team2_digits[y] }}</th>
                            <!-- Squares -->
                            {% for x in range(10) %}
                                {% set square = squares_map.get((x, y)) %}
                                {% set win_state = namespace(is_winner=false) %}
                                {% set square_winners = [] %}
                                {% for q_num, winner in winners.items() %}
                                    {% if winner.x == x and winner.y == y %}
                                        {% set win_state.is_winner = true %}
                                        {% set _ = square_winners.append({'q': q_num, 't1': winner.team1_score, 't2': winner.team2_score, 'payout': winner.payout}) %}
                                    {% endif %}
                                {% endfor %}
                                            <td class="fs-square-cell {% if square and square.participant_id %}assigned{% endif %} {% if win_state.is_winner %}is-winner{% endif %}" 
                                                style="{% if square and square.participant_id %}background-color: {{ square.participant.color }};{% endif %}"
                                                data-x="{{ x }}" 
                                    data-y="{{ y }}" 
                                    onclick='openAssignmentModal({{ x }}, {{ y }}, {{ (square.participant.name if square and square.participant_id else "")|tojson }}, {{ square.participant_id if square and square.participant_id else "null" }}, {{ square_winners|tojson }})'>
                                    <span class="fs-square-participant">{{ square.participant.name if square and square.participant_id else '' }}</span>
                                    {% if win_state.is_winner %}
                                    <div class="fs-winner-badge" title="Winner!">
                                        {% set q_labels = [] %}
                                        {% for q_num, winner in winners.items() %}
                                            {% if winner.x == x and winner.y == y %}
                                                {% if q_num == 5 %}
                                                    {% set _ = q_labels.append('OT') %}
                                                {% else %}
                                                    {% set _ = q_labels.append('Q' ~ q_num) %}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                        <span style="font-size: 0.6rem; margin-right: 2px;">{{ q_labels|join(',') }}</span>
                                        üèÜ
                                    </div>
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

{% set empty_squares_count = grid.squares|selectattr('participant_id', 'none')|list|length %}
{% set has_scores = grid.quarters|rejectattr('team1_score', 'none')|list|length > 0 or grid.quarters|rejectattr('team2_score', 'none')|list|length > 0 %}
{% if empty_squares_count > 0 and not has_scores %}
<div class="fs-grid-actions-bar">
    <form action="{{ url_for('football_squares.randomize_remaining', grid_id=grid.id) }}" method="POST" onsubmit="return confirm('Fill all remaining empty squares randomly?');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="fs-btn fs-btn-outline">Fill Remaining Randomly</button>
    </form>
    <form action="{{ url_for('football_squares.randomize_all', grid_id=grid.id) }}" method="POST" onsubmit="return confirm('This will CLEAR all current assignments and randomize the entire grid. Continue?');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="fs-btn fs-btn-outline">Randomize All</button>
    </form>
</div>
{% endif %}
        </section>
    </div>
</div>

<!-- Assignment Modal -->
<div id="assignmentModal" class="fs-modal-overlay">
    <div class="fs-modal">
        <h3 style="margin-bottom: 0.5rem;">Assign Square</h3>
        <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f4f4f4; border-radius: 4px; text-align: center; border: 1px solid var(--fs-border);">
            <div style="font-size: 0.9rem; color: var(--fs-text-light); text-transform: uppercase;">Matchup</div>
            <div style="font-size: 1.2rem; font-weight: bold; color: var(--fs-primary);">
                {{ grid.team1_name }}: <span id="modalXDigit"></span><br>
                {{ grid.team2_name }}: <span id="modalYDigit"></span>
            </div>
        </div>

        <div id="modalWinnerInfo" style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: #fff9c4; border: 1px solid #fbc02d; border-radius: 4px;">
            <div style="font-weight: bold; color: #856404; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                üèÜ Winner Information
            </div>
            <div id="modalWinnerDetails" style="font-size: 0.85rem;"></div>
        </div>

        <p>Select participant:</p>
        <select id="participantSelect" class="fs-modal-select">
            <option value="">-- Unassigned --</option>
            {% for participant in grid.participants %}
            <option value="{{ participant.id }}">{{ participant.name }}</option>
            {% endfor %}
        </select>
        <div class="fs-modal-actions" style="display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button onclick="closeAssignmentModal()" class="fs-btn fs-btn-outline fs-btn-sm">Cancel</button>
            <button id="saveAssignmentBtn" onclick="saveAssignment()" class="fs-btn fs-btn-primary fs-btn-sm">Save</button>
        </div>
    </div>
</div>

<script>
let currentX = null;
let currentY = null;

function openAssignmentModal(x, y, participantName, participantId, squareWinners = []) {
    currentX = x;
    currentY = y;
    
    // Check if scores have been entered for any quarter
    const scoringInputs = Array.from(document.querySelectorAll('.fs-scoring-table input[type="number"]'));
    const hasScores = scoringInputs.some(input => input.value.trim() !== "");
    
    const select = document.getElementById('participantSelect');
    const saveBtn = document.getElementById('saveAssignmentBtn');
    
    if (hasScores) {
        select.disabled = true;
        saveBtn.style.display = 'none';
    } else {
        select.disabled = false;
        saveBtn.style.display = 'inline-flex';
    }
    
    // Get the digits from the headers
    const team1Digits = "{{ grid.team1_digits }}".split(',');
    const team2Digits = "{{ grid.team2_digits }}".split(',');
    
    document.getElementById('modalXDigit').textContent = team1Digits[x];
    document.getElementById('modalYDigit').textContent = team2Digits[y];
    
    // Handle Winner Info
    const winnerInfo = document.getElementById('modalWinnerInfo');
    const winnerDetails = document.getElementById('modalWinnerDetails');
    
    if (squareWinners && squareWinners.length > 0) {
        winnerInfo.style.display = 'block';
        winnerDetails.innerHTML = squareWinners.map(w => {
            const qLabel = w.q === 5 ? 'OT' : `Q${w.q}`;
            return `<div style="margin-bottom: 0.25rem;">
                <strong>${qLabel}:</strong> Score ${w.t1}-${w.t2} 
                ${w.payout ? `<br><span style="color: #666; font-style: italic;">Prize: ${w.payout}</span>` : ''}
            </div>`;
        }).join('<hr style="margin: 0.5rem 0; border: 0; border-top: 1px solid rgba(0,0,0,0.1);">');
    } else {
        winnerInfo.style.display = 'none';
    }
    
    document.getElementById('participantSelect').value = participantId || "";
    document.getElementById('assignmentModal').style.display = 'flex';
}

function closeAssignmentModal() {
    document.getElementById('assignmentModal').style.display = 'none';
    currentX = null;
    currentY = null;
}

async function saveAssignment() {
    const participantId = document.getElementById('participantSelect').value;
    const response = await fetch(`{{ url_for('football_squares.assign_square', grid_id=grid.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            x: currentX,
            y: currentY,
            participant_id: participantId === "" ? null : participantId
        })
    });

    if (response.ok) {
        window.location.reload();
    } else {
        alert("Failed to save assignment.");
    }
}

function copyLink() {
    var copyText = document.getElementById("shareLink");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(copyText.value);
    alert("Copied to clipboard!");
}

function toggleScoring() {
    const el = document.getElementById('scoringCollapsible');
    if (el.style.display === 'none') {
        el.style.display = 'block';
    } else {
        el.style.display = 'none';
    }
}

function toggleSidebar() {
    const sidebar = document.getElementById('fsSidebar');
    const toggleText = document.getElementById('sidebarToggleText');
    
    if (sidebar.classList.contains('collapsed')) {
        sidebar.classList.remove('collapsed');
        toggleText.textContent = 'Hide Sidebar';
    } else {
        sidebar.classList.add('collapsed');
        toggleText.textContent = 'Show Sidebar';
    }
}
</script>

<style>
.fs-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}
.fs-card-header h3 { margin: 0; }
.fs-status-pill {
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 12px;
    background: #eee;
}
.fs-status-locked {
    background: #fff3f3;
    color: #d32f2f;
    border: 1px solid #ffcdd2;
}
</style>
{% endblock %}
